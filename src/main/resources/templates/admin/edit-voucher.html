<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle}">Edit Voucher</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --primary-gradient-hover: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            --primary-color: #667eea;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --light-bg: #f8f9fa;
            --border-color: #dee2e6;
        }

        body {
            background-color: var(--light-bg);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background: var(--primary-gradient) !important;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            color: white !important;
            font-weight: bold;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.8) !important;
            transition: color 0.2s ease;
        }

        .nav-link:hover {
            color: white !important;
        }

        .nav-link.active {
            color: white !important;
            font-weight: 600;
        }

        .card {
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            border: none;
            border-radius: 15px;
        }

        .card-header {
            background: var(--primary-gradient);
            color: white;
            font-weight: bold;
            border-radius: 15px 15px 0 0 !important;
        }

        .form-label {
            font-weight: 600;
            color: #495057;
        }

        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .btn-primary {
            background: var(--primary-gradient);
            border: none;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            background: var(--primary-gradient-hover);
            transform: translateY(-1px);
        }

        .btn-secondary {
            border-radius: 8px;
        }

        .required {
            color: var(--danger-color);
        }

        .form-text {
            color: #6c757d;
            font-size: 0.875rem;
        }

        .input-group-text {
            background-color: #e9ecef;
            border-color: var(--border-color);
        }

        .alert {
            border-radius: 10px;
        }

        .breadcrumb-item a {
            color: var(--primary-color);
            text-decoration: none;
        }

        .breadcrumb-item a:hover {
            color: var(--primary-gradient-hover);
        }

        @media (max-width: 768px) {
            .btn-group-mobile {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
        <a class="navbar-brand" href="/admin">
            <i class="fas fa-film"></i> BlueBear Cinema
        </a>
        <div class="navbar-nav ms-auto">
            <a class="nav-link" href="/admin/">Dashboard</a>
            <a class="nav-link" href="/admin/movies">Movies</a>
            <a class="nav-link" href="/admin/actors">Actors</a>
            <a class="nav-link active" href="/admin/vouchers">Vouchers</a>
            <a class="nav-link" href="/admin/genres">Genres</a>
        </div>
    </div>
</nav>

<div class="container">
    <!-- Alert Messages -->
    <div th:if="${success}" class="alert alert-success alert-dismissible fade show">
        <i class="fas fa-check-circle"></i>
        <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
        <i class="fas fa-exclamation-circle"></i>
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>
                <i class="fas fa-edit"></i>
                <span th:text="${isEdit ? 'Chỉnh Sửa Voucher' : 'Thêm Voucher Mới'}">Chỉnh Sửa Voucher</span>
            </h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/admin/">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="/admin/vouchers">Vouchers</a></li>
                    <li class="breadcrumb-item active" th:text="${isEdit ? 'Chỉnh Sửa' : 'Thêm Mới'}">Chỉnh Sửa</li>
                </ol>
            </nav>
        </div>
        <div class="d-flex btn-group-mobile">
            <a href="/admin/vouchers" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Quay Lại
            </a>
        </div>
    </div>

    <!-- Form -->
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-ticket-alt"></i> Thông Tin Voucher
                </div>
                <div class="card-body">
                    <form th:action="${isEdit ? '/admin/vouchers/edit/' + voucher.promotionID : '/admin/vouchers/add'}"
                          method="post" th:object="${voucher}">

                        <!-- Promotion Code -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="promotionCode" class="form-label">
                                    Mã Voucher <span class="required">*</span>
                                </label>
                                <input type="text"
                                       class="form-control"
                                       id="promotionCode"
                                       th:field="*{promotionCode}"
                                       placeholder="Nhập mã voucher (vd: SAVE20)"
                                       maxlength="10"
                                       required>
                                <div class="form-text">Mã voucher phải là duy nhất, tối đa 10 ký tự và không chứa khoảng trắng</div>
                            </div>

                            <!-- Discount -->
                            <div class="col-md-6">
                                <label for="discount" class="form-label">
                                    Giá Trị Giảm Giá (%) <span class="required">*</span>
                                </label>
                                <div class="input-group">
                                    <input type="number"
                                           class="form-control"
                                           id="discount"
                                           th:field="*{discount}"
                                           placeholder="20"
                                           min="1"
                                           max="100"
                                           required>
                                    <span class="input-group-text">%</span>
                                </div>
                                <div class="form-text">Nhập giá trị từ 1% đến 100%</div>
                            </div>
                        </div>

                        <!-- Dates -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="startTime" class="form-label">
                                    Ngày Bắt Đầu <span class="required" th:if="${!isEdit}">*</span>
                                </label>
                                <input type="datetime-local"
                                       class="form-control"
                                       id="startTime"
                                       th:field="*{startTime}"
                                       th:required="${!isEdit}">
                                <div class="form-text">
                                    <span th:if="${isEdit}">Để trống nếu không muốn thay đổi ngày bắt đầu</span>
                                    <span th:unless="${isEdit}">Chọn ngày và giờ bắt đầu hiệu lực</span>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label for="endTime" class="form-label">
                                    Ngày Kết Thúc <span class="required" th:if="${!isEdit}">*</span>
                                </label>
                                <input type="datetime-local"
                                       class="form-control"
                                       id="endTime"
                                       th:field="*{endTime}"
                                       th:required="${!isEdit}">
                                <div class="form-text">
                                    <span th:if="${isEdit}">Để trống nếu không muốn thay đổi ngày kết thúc</span>
                                    <span th:unless="${isEdit}">Chọn ngày và giờ kết thúc hiệu lực</span>
                                </div>
                            </div>
                        </div>

                        <!-- Quantity and Status -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="quantity" class="form-label">
                                    Số Lượng <span class="required">*</span>
                                </label>
                                <input type="number"
                                       class="form-control"
                                       id="quantity"
                                       th:field="*{quantity}"
                                       placeholder="100"
                                       min="1"
                                       required>
                                <div class="form-text">Nhập số lượng voucher có thể sử dụng</div>
                            </div>

                            <div class="col-md-6">
                                <label for="status" class="form-label">
                                    Trạng Thái <span class="required">*</span>
                                </label>
                                <select class="form-select"
                                        id="status"
                                        th:field="*{status}"
                                        required>
                                    <option value="">Chọn trạng thái</option>
                                    <option value="Available">Đang Hoạt Động</option>
                                    <option value="Expired">Hết Hạn</option>
                                </select>
                                <div class="form-text">Chọn trạng thái hiện tại của voucher</div>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="d-flex justify-content-between">
                            <a href="/admin/vouchers" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Hủy
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i>
                                <span th:text="${isEdit ? 'Cập Nhật Voucher' : 'Thêm Voucher'}">Cập Nhật Voucher</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Help Card -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-info-circle"></i> Hướng Dẫn
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6><i class="fas fa-tag text-primary"></i> Mã Voucher</h6>
                        <p class="small text-muted">Mã voucher phải là duy nhất, tối đa 10 ký tự, không chứa khoảng trắng và dễ nhớ.</p>
                    </div>

                    <div class="mb-3">
                        <h6><i class="fas fa-percentage text-success"></i> Giá Trị Giảm</h6>
                        <p class="small text-muted">Nhập giá trị phần trăm giảm giá từ 1% đến 100%.</p>
                    </div>

                    <div class="mb-3">
                        <h6><i class="fas fa-calendar text-warning"></i> Thời Gian</h6>
                        <p class="small text-muted">
                            <span th:if="${isEdit}">Để trống nếu không muốn thay đổi thời gian. Nếu nhập, ngày kết thúc phải sau ngày bắt đầu.</span>
                            <span th:unless="${isEdit}">Ngày kết thúc phải sau ngày bắt đầu.</span>
                        </p>
                    </div>

                    <div class="mb-3">
                        <h6><i class="fas fa-hashtag text-info"></i> Số Lượng</h6>
                        <p class="small text-muted">Số lượng voucher có thể được sử dụng.</p>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-lightbulb"></i>
                        <small>
                            <span th:if="${isEdit}">Lưu ý: Chỉ cập nhật những trường bạn muốn thay đổi. Các trường để trống sẽ giữ nguyên giá trị cũ.</span>
                            <span th:unless="${isEdit}">Lưu ý: Sau khi lưu, voucher sẽ có thể được sử dụng ngay lập tức nếu đang trong thời gian hiệu lực.</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script>
    // Auto-hide alerts after 5 seconds
    setTimeout(function() {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(function(alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        });
    }, 5000);

    // Check if this is edit mode
    const isEdit = document.querySelector('[th\\:text="${isEdit ? \'Chỉnh Sửa Voucher\' : \'Thêm Voucher Mới\'}"]').textContent.includes('Chỉnh Sửa');

    // Validate dates
    document.addEventListener('DOMContentLoaded', function() {
        const startTimeInput = document.getElementById('startTime');
        const endTimeInput = document.getElementById('endTime');

        function validateDates() {
            const startTime = startTimeInput.value;
            const endTime = endTimeInput.value;

            // Only validate if both dates are provided
            if (startTime && endTime) {
                const startDate = new Date(startTime);
                const endDate = new Date(endTime);

                if (startDate >= endDate) {
                    endTimeInput.setCustomValidity('Ngày kết thúc phải sau ngày bắt đầu');
                } else {
                    endTimeInput.setCustomValidity('');
                }
            } else {
                // Clear validation if dates are not provided (for edit mode)
                endTimeInput.setCustomValidity('');
            }
        }

        startTimeInput.addEventListener('change', validateDates);
        endTimeInput.addEventListener('change', validateDates);

        // Set minimum date to today only for new vouchers
        if (!isEdit) {
            const now = new Date();
            const today = now.toISOString().slice(0, 16);
            startTimeInput.min = today;
            endTimeInput.min = today;
        }
    });

    // Validate promotion code format
    document.getElementById('promotionCode').addEventListener('input', function(e) {
        const value = e.target.value;
        const validFormat = /^[A-Z0-9]+$/;

        if (value && !validFormat.test(value)) {
            e.target.setCustomValidity('Mã voucher chỉ được chứa chữ cái viết hoa và số, không có khoảng trắng');
        } else {
            e.target.setCustomValidity('');
        }
    });

    // Format promotion code to uppercase
    document.getElementById('promotionCode').addEventListener('input', function(e) {
        e.target.value = e.target.value.toUpperCase();
    });
</script>
</body>
</html>