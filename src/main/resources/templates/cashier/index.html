<!DOCTYPE html>
<html lang="vi" xmlns:th="[http://www.thymeleaf.org](http://www.thymeleaf.org)">
<head>
    <meta charset="UTF-8">
    <title>Thanh toán đơn hàng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-6">
            <div id="checkout_box" class="card card-custom text-center">
                <div class="card-header">
                    <h5 class="mb-0">Quét mã QR để thanh toán</h5>
                </div>
                <div class="card-body">
                    <img th:src="@{'https://qr.sepay.vn/img?bank=' + ${sepayBank} + '&acc=' + ${sepayAccount} + '&template=compact&amount=' + ${invoiceDto.totalPrice} + '&des=DH' + ${invoiceDto.invoiceID}}">
                    <div class="alert alert-info">
                        <p class="mb-1">Nội dung chuyển khoản: <strong th:text="'DH' + ${invoiceDto.invoiceID}"></strong></p>
                        <p class="mb-0">Số tiền: <strong class="text-warning" th:text="${#numbers.formatDecimal(invoiceDto.totalPrice, 0, 'COMMA', 0, 'POINT')} + '₫'"></strong></p>
                    </div>

                    <div class="mt-4">
                        <div class="spinner-border text-warning" role="status"></div>
                        <p class="text-muted mt-2">Đang chờ xác nhận thanh toán...</p>
                    </div>
                </div>
            </div>

            <div id="success_pay_box" class="card card-custom text-center" style="display:none;">
                <div class="card-body py-5">
                    <i class="fas fa-check-circle text-success" style="font-size: 5rem;"></i>
                    <h3 class="mt-3">Thanh toán thành công!</h3>
                    <p class="text-muted">Đang chuyển hướng đến trang kết quả...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    var pay_status = 'Unpaid';
    var order_id = /*[[${invoiceDto.invoiceID}]]*/ '0';

    function check_payment_status() {
        if (pay_status == 'Unpaid') {
            $.ajax({
                type: "POST",
                data: { order_id: order_id },
                url: "/cashier/check-payment-status",
                dataType: "json",
                success: function(data) {
                    if (data.payment_status == "Booked" || data.payment_status == "Paid") {
                        pay_status = 'Paid';
                        $("#checkout_box").hide();
                        $("#success_pay_box").show();
                        setTimeout(function() {
                            window.location.href = "/cashier/booking-success/" + order_id;
                        }, 2000);
                    }
                },
                error: function() {
                    console.log("Error checking payment status.");
                }
            });
        }
    }
    setInterval(check_payment_status, 3000);
</script>

</body>
</html>