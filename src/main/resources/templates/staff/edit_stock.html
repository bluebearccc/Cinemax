<!DOCTYPE html>

<html xmlns:th="http://www.thymeleaf.org" lang="vi">



<head>

  <meta charset="UTF-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Food And Drink</title>

  <link rel="stylesheet" th:href="@{/staff/css/style.css}">

  <link rel="stylesheet" th:href="@{/staff/css/add_update_item.css}">

</head>



<body>

<!-- Sidebar -->

<div class="sidebar">

  <div class="user-info">

    <div class="user-avatar" >M</div>

    <div class="user-name" >Mary Johnson</div>

  </div>



  <a href="#" class="sidebar-item">

    <div class="sidebar-icon">üè†</div>

    <div class="sidebar-text">Home</div>

  </a>

  <a th:href="@{/theater_stock}" class="sidebar-item active">

    <div class="sidebar-icon">üçø</div>

    <div class="sidebar-text">Food and Drinks</div>

  </a>

  <a th:href="@{/movie_schedule}" class="sidebar-item ">

    <div class="sidebar-icon">üìÖ</div>

    <div class="sidebar-text">Set Schedule</div>

  </a>

  <a th:href="@{/theater}" class="sidebar-item ">

    <div class="sidebar-icon">üé¨</div>

    <div class="sidebar-text">Manage Theater</div>

  </a>

</div>



<!-- Main Content -->

<div class="main-content">

  <!-- Header -->

  <div class="header">
    <div class="header-left">
      <div class="breadcrumb">
        <a href="#" th:href="@{/theater_stock}">Food and Drinks</a> >
        <span> Update Item</span>
      </div>
    </div>
  </div>
  <!-- Form Container -->
  <div class="form-container">
    <div th:if="${isMultiTheaterItem}" class="alert alert-warning">
      <strong>‚ö†Ô∏è Warning:</strong> This product exists in multiple theaters. Any changes to Name, Price, and Image will be applied to all theaters that have this product.
    </div>
    <div class="form-header">
      <p class="form-subtitle">Complete the item information</p>
    </div>
    <form th:action="@{/theater_stock/edit_stock}"
          th:object="${theaterStock}"
          method="post"
          enctype="multipart/form-data"
          id="stockForm"
          onsubmit="return validateForm()">
      <input type="hidden" th:field="*{theaterStockId}">
      <div class="form-row">
        <!-- Left Column - General Information -->
        <div class="form-column">
          <!-- Name -->
          <div class="form-group">
            <label class="form-label">Name</label>
            <input type="text"
                   class="form-input"
                   th:field="*{foodName}"
                   maxlength="20"
                   placeholder="Enter item name"
                   required>
            <div class="error-message" id="nameError"></div>
          </div>
          <!-- Quantity -->
          <div class="form-group">
            <label class="form-label">Quantity</label>
            <input type="number"
                   class="form-input"
                   th:field="*{quantity}"
                   min="0"
                   step="1"
                   placeholder="Enter quantity"
                   required>
            <div class="error-message" id="quantityError"></div>
          </div>
          <!-- Price -->
          <div class="form-group">
            <label class="form-label">Price</label>
            <input type="number"
                   step="0.01"
                   class="form-input"
                   th:field="*{unitPrice}"
                   min="0"
                   max="99999999.99"
                   placeholder="Enter price"
                   required>
            <div class="error-message" id="priceError"></div>
          </div>
          <!-- Status -->
          <div class="form-group">
            <label class="form-label">Set Status</label>
            <div class="radio-group">
              <div class="radio-item">
                <input type="radio"
                       id="statusActive"
                       name="status"
                       value="Active"
                       th:field="*{status}"
                       th:checked="${theaterStock.status == 'Active'}"
                       checked
                >
                <label for="statusActive">Active</label>
              </div>
              <div class="radio-item">
                <input type="radio"
                       id="statusInactive"
                       name="status"
                       value="Inactive"
                       th:field="*{status}"
                       th:checked="${theaterStock.status == 'Inactive'}">
                <label for="statusInactive">Inactive</label>
              </div>
            </div>
            <div class="error-message" id="statusError"></div>
          </div>
        </div>
        <!-- Right Column - Image Upload -->
        <!-- Current Upload -->
        <div class="form-column">
          <div class="form-group">
            <label class="form-label">Current Image:</label>
            <img th:if="${theaterStock.image}"
                 th:src="${theaterStock.image}"
                 class="current-image"
                 alt="Current Image">
            <input type="hidden" th:field="*{image}">
          </div>
          <!-- Image Upload -->
          <div class="form-group">
            <label class="form-label">Upload New Image</label>
            <div class="image-upload-area" onclick="document.getElementById('imageInput').click()">
              <div>üì∏</div>
              <p>Click to upload</p>
            </div>
            <input type="file"
                   id="imageInput"
                   name="imageInput"
                   accept="image/*"
                   style="display: none;"
                   onchange="previewImage(this)">
            <div id="imagePreview" class="image-preview"></div>
            <div class="error-message" id="imageError"></div>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Theater</label>
        <select class="form-input" th:field="*{theater.theaterID}" required>
          <option th:each="theater : ${allTheaters}"
                  th:value="${theater.theaterID}"
                  th:text="${theater.theaterName}">
          </option>
        </select>
        <div class="error-message" id="theaterError"></div>
      </div>
      <!-- Buttons -->
      <div class="form-buttons">
        <button type="submit" class="btn btn-primary">Save</button>
        <button type="reset" class="btn btn-secondary" onclick="resetForm()">Reset</button>
        <a th:href="@{/theater_stock}" class="btn btn-danger">Cancel</a>
      </div>
    </form>
  </div>
</div>
<script>
  // --- C√ÅC H√ÄM X·ª¨ L√ù ---
  // C√°c h√†m n√†y c√≥ th·ªÉ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a ·ªü ngo√†i v√¨ ch√∫ng s·∫Ω ch·ªâ ƒë∆∞·ª£c g·ªçi khi c√≥ s·ª± ki·ªán x·∫£y ra.

  // H√†m xem tr∆∞·ªõc ·∫£nh
  function previewImage(input) {
    const preview = document.getElementById('imagePreview');
    preview.innerHTML = '';
    if (input.files && input.files[0]) {
      const file = input.files[0];
      if (!file.type.startsWith('image/')) {
        alert('Please upload an image file');
        input.value = '';
        return;
      }
      const reader = new FileReader();
      reader.onload = function (e) {
        const img = document.createElement('img');
        img.src = e.target.result;
        preview.appendChild(img);
      };
      reader.readAsDataURL(file);
    }
  }

  // H√†m reset form
  function resetForm() {
    document.getElementById('stockForm').reset();
    document.getElementById('imagePreview').innerHTML = '';
    document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
    const activeRadio = document.getElementById('statusActive');
    if(activeRadio) {
      activeRadio.checked = true;
    }
  }

  // H√†m ki·ªÉm tra to√†n b·ªô form tr∆∞·ªõc khi submit
  // H√†m ki·ªÉm tra to√†n b·ªô form tr∆∞·ªõc khi submit
  function validateForm() {
    let isValid = true;
    // X√≥a c√°c th√¥ng b√°o l·ªói c≈©
    document.querySelectorAll('.error-message').forEach(el => el.textContent = '');

    const nameInput = document.querySelector('input[name="foodName"]');
    const quantityInput = document.querySelector('input[name="quantity"]');
    const priceInput = document.querySelector('input[name="unitPrice"]');
    const imageInput = document.getElementById('imageInput');
    const currentImage = document.querySelector('input[name="image"]');

    const name = nameInput ? nameInput.value.trim() : '';
    const quantity = quantityInput ? quantityInput.value : '';
    const price = priceInput ? priceInput.value : '';

    const status = document.querySelector('input[name="status"]:checked');
    const selectedTheaters = document.querySelectorAll('input[name="theaterIds"]:checked').length;

    // Validate Name (gi·ªØ nguy√™n)
    const nameRegex = /^[a-zA-Z0-9\s]+$/;
    if (!name) {
      document.getElementById('nameError').textContent = 'Name is required';
      isValid = false;
    } else if (!nameRegex.test(name)) {
      document.getElementById('nameError').textContent = 'Name must not contain special characters';
      isValid = false;
    }

    // ... Validate Quantity v√† Price (gi·ªØ nguy√™n) ...

    // Validate Status (gi·ªØ nguy√™n)
    if (!status) {
      document.getElementById('statusError').textContent = 'Please select a status';
      isValid = false;
    }

    // S·ª¨A L·∫†I VALIDATE CHO THEATER
    if (selectedTheaters === 0) {
      // alert('Please select at least one theater.'); // D√≤ng c≈©
      document.getElementById('theaterError').textContent = 'Please select at least one theater.'; // D√≤ng m·ªõi
      isValid = false;
    }

    // S·ª¨A L·∫†I VALIDATE CHO IMAGE
    if (!imageInput.files || imageInput.files.length === 0) {
      // Ch·ªâ b·∫Øt bu·ªôc upload ·∫£nh khi th√™m m·ªõi. Khi edit, ·∫£nh c≈© l√† h·ª£p l·ªá.
      if (!currentImage || !currentImage.value) { // ƒê∆°n gi·∫£n h√≥a ƒëi·ªÅu ki·ªán
        // alert('Please upload an image'); // D√≤ng c≈©
        document.getElementById('imageError').textContent = 'Please upload an image.'; // D√≤ng m·ªõi
        isValid = false;
      }
    } else {
      const file = imageInput.files[0];
      if (!file.type.startsWith('image/')) {
        // alert('Please upload a valid image file'); // D√≤ng c≈©
        document.getElementById('imageError').textContent = 'Please upload a valid image file (PNG, JPG, etc.).'; // D√≤ng m·ªõi
        isValid = false;
      }
    }

    return isValid;
  }
  // --- G·∫ÆN C√ÅC S·ª∞ KI·ªÜN SAU KHI TRANG ƒê√É T·∫¢I XONG ---
  // To√†n b·ªô m√£ thi·∫øt l·∫≠p s·ª± ki·ªán s·∫Ω n·∫±m trong n√†y.
  document.addEventListener('DOMContentLoaded', function() {

    // G√°n s·ª± ki·ªán cho c√°c √¥ input ƒë·ªÉ validate real-time
    const nameInput = document.querySelector('input[th\\:field="*{foodName}"]');
    if(nameInput) {
      nameInput.addEventListener('input', function(e) {
        const nameRegex = /^[a-zA-Z0-9\s]+$/;
        const nameError = document.getElementById('nameError');
        const value = e.target.value;
        if (value && !nameRegex.test(value)) {
          nameError.textContent = 'Name can only contain letters, numbers, and spaces';
        } else {
          nameError.textContent = '';
        }
      });
    }

    const quantityInput = document.querySelector('input[th\\:field="*{quantity}"]');
    if(quantityInput) {
      quantityInput.addEventListener('input', function(e) {
        const quantityError = document.getElementById('quantityError');
        const value = e.target.value;
        if (value && (!/^\d+$/.test(value) || parseInt(value) < 0)) {
          quantityError.textContent = 'Quantity must be a non-negative whole number';
        } else {
          quantityError.textContent = '';
        }
      });
    }

    const priceInput = document.querySelector('input[th\\:field="*{unitPrice}"]');
    if(priceInput) {
      priceInput.addEventListener('input', function(e) {
        const priceError = document.getElementById('priceError');
        if (e.target.value && e.target.value < 0) {
          priceError.textContent = 'Price must be a positive number';
        } else {
          priceError.textContent = '';
        }
      });
    }

    // G√°n s·ª± ki·ªán cho khu v·ª±c k√©o-th·∫£ ·∫£nh
    const uploadArea = document.querySelector('.image-upload-area');
    if(uploadArea) {
      uploadArea.addEventListener('dragover', function (e) {
        e.preventDefault();
        this.classList.add('dragover');
      });

      uploadArea.addEventListener('dragleave', function (e) {
        e.preventDefault();
        this.classList.remove('dragover');
      });

      uploadArea.addEventListener('drop', function (e) {
        e.preventDefault();
        this.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].type.startsWith('image/')) {
          document.getElementById('imageInput').files = files;
          previewImage(document.getElementById('imageInput'));
        }
      });
    }
  });
</script>
</body>
</html>