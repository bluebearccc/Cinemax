<!DOCTYPE html>

<html xmlns:th="http://www.thymeleaf.org" lang="vi">



<head>

  <meta charset="UTF-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Edit Seats</title>

  <link rel="stylesheet" th:href="@{/staff/css/style.css}">

  <link rel="stylesheet" th:href="@{/staff/css/add_update_item.css}">

  <style>

    /* ========== C√ÅC STYLE CHUNG ========== */

    .alert {

      padding: 15px; margin-bottom: 20px; border: 1px solid transparent;

      border-radius: 4px; font-size: 16px; text-align: center;

    }

    .alert-error {

      color: #a94442; background-color: #f2dede; border-color: #ebccd1;

    }

    .alert-success {

      color: #3c763d; background-color: #dff0d8; border-color: #d6e9c6;

    }



    /* ========== LAYOUT CH√çNH ========== */

    .seat-map-container {

      background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);

      padding: 25px; margin-top: 20px; overflow-x: auto; max-width: 100%;

    }

    .seat-map-header {

      text-align: center; margin-bottom: 30px; padding-bottom: 20px;

      border-bottom: 2px solid #f0f0f0;

    }

    .seat-map-title {

      font-size: 24px; font-weight: 600; color: #333; margin: 0 0 10px 0;

    }

    .screen-area {

      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);

      color: white; text-align: center; padding: 15px; border-radius: 8px;

      margin: 0 auto 40px auto; max-width: 80%; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);

    }

    .screen-text {

      font-size: 18px; font-weight: 600; margin: 0;

    }



    /* ========== S∆† ƒê·ªí GH·∫æ ========== */

    .seat-grid-wrapper {

      margin: 0 auto;

      max-width: fit-content;

    }

    .seat-grid {

      display: grid;

      gap: 16px;

      justify-content: flex-start;

    }

    .seat-row {

      display: flex;

      align-items: center;

      gap: 16px;

    }

    .row-label {

      width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;

      font-weight: 600; color: #666; background: #f8f9fa; border-radius: 50%;

      font-size: 14px; flex-shrink: 0;

    }

    .column-headers {

      display: flex;

      align-items: center;

      gap: 16px;

      margin-bottom: 10px;

    }

    .column-label {

      width: 50px; height: 30px; display: flex; align-items: center; justify-content: center;

      font-weight: 600; color: #333; background-color: #e9ecef; border-radius: 6px;

    }



    /* ========== GIAO DI·ªÜN GH·∫æ (ƒê√É S·ª¨A L·ªñI) ========== */

    .seat-container {

      position: relative;

    }

    .seat-empty {

      width: 50px; height: 50px; flex-shrink: 0;

    }

    .seat {

      width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;

      border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease-in-out;

      background-color: #cceeff; border: 2px solid #99d6ff; color: #004085;

      position: relative; user-select: none;

    }

    .seat:hover {

      transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.1);

    }

    .vip-checkbox-hidden {

      display: none;

    }



    /* Style cho gh·∫ø VIP, d·ª±a v√†o class .vip m√† JS th√™m v√†o */

    .seat.vip {

      background-color: #ffeb99;

      border-color: #ffc107;

      color: #856404;

    }

    /* Th√™m ng√¥i sao cho gh·∫ø VIP */

    .seat.vip::after {

      content: '‚≠ê';

      position: absolute;

      top: -2px;

      right: -2px;

      font-size: 12px;

    }



    .delete-seat-btn {

      position: absolute; top: -10px; right: -10px; background: white; border: 1px solid #ddd;

      border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center;

      justify-content: center; font-size: 12px; cursor: pointer; opacity: 0;

      transition: opacity 0.2s; z-index: 10;

    }

    .seat-container:hover .delete-seat-btn {

      opacity: 1;

    }

  </style>

</head>



<body>

<div class="sidebar">

  <div class="user-info">

    <div class="user-avatar">M</div>

    <div class="user-name">Mary Johnson</div>

  </div>

  <a href="#" class="sidebar-item"><div class="sidebar-icon">üè†</div><div class="sidebar-text">Home</div></a>

  <a th:href="@{/theater_stock}" class="sidebar-item"><div class="sidebar-icon">üçø</div><div class="sidebar-text">Food and Drinks</div></a>

  <a th:href="@{/movie_schedule}" class="sidebar-item"><div class="sidebar-icon">üìÖ</div><div class="sidebar-text">Set Schedule</div></a>

  <a th:href="@{/theater}" class="sidebar-item active"><div class="sidebar-icon">üé¨</div><div class="sidebar-text">Manage Theater</div></a>

</div>



<div class="main-content">

  <div class="header">

    <div class="header-left">

      <div class="breadcrumb">

        <a th:href="@{/theater}">Theater Management</a> >

        <a th:href="@{/theater/theater_detail(id=${room.theaterID})}">Theater Details</a> >

        <span th:text="'Edit Seats for Room ' + ${room.name}"></span>

      </div>

    </div>

  </div>



  <form id="seatForm" th:action="@{/theater/update_seats}" th:object="${seatUpdateRequest}" method="post">

    <input type="hidden" name="roomId" th:value="${room.roomID}" />



    <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>

    <div th:if="${errorMessage}" class="alert alert-error" th:text="${errorMessage}"></div>



    <div class="form-container">

      <div class="left-column">

        <div class="form-header"><p class="form-subtitle">Set ticket prices and select VIP seats</p></div>

        <div class="form-group">

          <label class="form-label">Standard Seat Price (VND)</label>

          <input type="number" class="form-input" th:field="*{nonVipPrice}" placeholder="Enter standard seat price" min="1000" step="0.01" required>

        </div>

        <div class="form-group">

          <label class="form-label">VIP Seat Price (VND)</label>

          <input type="number" class="form-input" th:field="*{vipPrice}" placeholder="Enter VIP seat price" min="1000" step="0.01" required>

        </div>

        <div id="price-error-message" class="alert alert-error" style="display:none; margin-top: 15px;"></div>

        <div class="form-group">

          <fieldset style="border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-top: 20px;">

            <legend style="font-weight: 600; padding: 0 10px;">Set VIP by Range</legend>

            <div style="display: flex; gap: 10px; margin-bottom: 10px;">

              <div style="flex: 1;"><label class="form-label">From Row</label><input type="text" id="fromRow" class="form-input" placeholder="A" style="text-transform: uppercase;"></div>

              <div style="flex: 1;"><label class="form-label">To Row</label><input type="text" id="toRow" class="form-input" placeholder="C" style="text-transform: uppercase;"></div>

            </div>

            <div style="display: flex; gap: 10px;">

              <div style="flex: 1;"><label class="form-label">From Column</label><input type="number" id="fromCol" class="form-input" placeholder="1" min="1"></div>

              <div style="flex: 1;"><label class="form-label">To Column</label><input type="number" id="toCol" class="form-input" placeholder="5" min="1"></div>

            </div>

            <div style="margin-top: 15px; display: flex; gap: 10px;">

              <button type="button" id="applyVipRangeBtn" class="btn btn-secondary">Apply VIP Range</button>

              <button type="button" id="clearVipBtn" class="btn btn-danger">Clear All VIP</button>

            </div>

          </fieldset>

        </div>

      </div>



      <div class="right-column">

        <div class="seat-map-container">

          <div class="seat-map-header"><h3 class="seat-map-title" th:text="'Seat Map: ' + ${room.name}"></h3></div>

          <div class="screen-area"><p class="screen-text">SCREEN</p></div>



          <div class="seat-grid-wrapper">

            <div class="column-headers">

              <div class="row-label"></div>

              <th:block th:each="col : ${#numbers.sequence(1, room.column)}">

                <div class="column-label" th:text="${col}"></div>

              </th:block>

            </div>



            <div class="seat-grid">

              <th:block th:each="row : ${#numbers.sequence(1, room.row)}">

                <div class="seat-row">

                  <div class="row-label" th:text="${#strings.substring('ABCDEFGHIJKLMNOPQRSTUVWXYZ', row - 1, row)}"></div>

                  <th:block th:each="col : ${#numbers.sequence(1, room.column)}">

                    <th:block th:with="seatPosition=${#strings.substring('ABCDEFGHIJKLMNOPQRSTUVWXYZ', row - 1, row) + col}">

                      <th:block th:with="currentSeats=${room.seats.?[position == #vars.seatPosition]}">



                        <div th:if="${not #lists.isEmpty(currentSeats)}" th:with="seat=${currentSeats[0]}" class="seat-container" th:id="'seat-container-' + ${seat.seatID}">

                          <input type="checkbox" th:id="'vip-check-' + ${seat.seatID}" class="vip-checkbox-hidden" th:field="*{vipSeatIds}" th:value="${seat.seatID}" />

                          <label th:for="'vip-check-' + ${seat.seatID}" class="seat" th:classappend="${seat.isVIP} ? 'vip'">

                            <span class="seat-name" th:text="${seat.name}"></span>

                            <button type="button" class="delete-seat-btn" th:data-seat-id="${seat.seatID}">‚ùå</button>

                          </label>

                        </div>



                        <div th:if="${#lists.isEmpty(currentSeats)}" class="seat-empty"></div>

                      </th:block>

                    </th:block>

                  </th:block>

                </div>

              </th:block>

            </div>

          </div>

        </div>

      </div>

    </div>



    <div class="form-buttons">

      <button type="submit" class="btn btn-primary">Save Prices & VIP</button>

      <a th:href="@{/theater/theater_detail(id=${room.theaterID})}" class="btn btn-danger">Go Back</a>

    </div>

  </form>

</div>



<script th:inline="javascript">

  /*<![CDATA[*/

  document.addEventListener('DOMContentLoaded', function() {

    const mainContent = document.querySelector('.main-content');

    const seatGrid = document.querySelector('.seat-grid');



// --- X·ª≠ l√Ω x√≥a gh·∫ø ---

    if (seatGrid) {

      seatGrid.addEventListener('click', function(event) {

        if (event.target && event.target.classList.contains('delete-seat-btn')) {

          event.preventDefault();

          const seatId = event.target.getAttribute('data-seat-id');
          if (confirm('Do you want to delete this seat?')) {
            fetch(`/theater/seats/${seatId}`, {
              method: 'DELETE'
            })
                    .then(response => {
                      if (!response.ok) {
                        throw new Error('Failed to delete seat!');
                      }
                      return response.json();
                    })
                    .then(updatedSeats => {
                      redrawSeatGrid(updatedSeats);
                    })
                    .catch(error => {
                      console.error('Error:', error);
                      alert(error.message);
                    });
          }
        }
      });
      seatGrid.addEventListener('change', function(event) {
        // Ch·ªâ x·ª≠ l√Ω n·∫øu ph·∫ßn t·ª≠ thay ƒë·ªïi l√† m·ªôt checkbox VIP
        if (event.target.classList.contains('vip-checkbox-hidden')) {
          const checkbox = event.target;
          // T√¨m th·∫ª <label> l√† √¥ gh·∫ø t∆∞∆°ng ·ª©ng
          const seatLabel = checkbox.closest('.seat-container').querySelector('.seat');

          if (seatLabel) {
            // N·∫øu checkbox ƒë∆∞·ª£c ch·ªçn, th√™m class 'vip'. Ng∆∞·ª£c l·∫°i, x√≥a class 'vip'.
            if (checkbox.checked) {
              seatLabel.classList.add('vip');
            } else {
              seatLabel.classList.remove('vip');
            }
          }
        }
      });

    }



    function redrawSeatGrid(seats) {

      seats.forEach(seat => {
        const seatNameSpan = document.querySelector(`#seat-container-${seat.seatID} .seat-name`);
        if (seatNameSpan) {
        seatNameSpan.textContent = seat.name;
        }
      });

      const existingSeatContainers = document.querySelectorAll('.seat-container');
      const updatedSeatIds = seats.map(s => s.seatID.toString());
      existingSeatContainers.forEach(container => {
        const containerId = container.id.split('-')[2];
        if (!updatedSeatIds.includes(containerId)) {
          const emptyUnit = document.createElement('div');
          emptyUnit.className = 'seat-empty';
          container.parentNode.replaceChild(emptyUnit, container);
        }
      });
    }
    mainContent.addEventListener('click', function(event) {
      const targetId = event.target.id;
      if (targetId === 'applyVipRangeBtn') {
        const fromRow = document.getElementById('fromRow').value.trim().toUpperCase();
        const toRow = document.getElementById('toRow').value.trim().toUpperCase();
        const fromCol = parseInt(document.getElementById('fromCol').value);
        const toCol = parseInt(document.getElementById('toCol').value);
        const roomSeats = [[${room.seats}]];
        if (!fromRow || !toRow || isNaN(fromCol) || isNaN(toCol)) {
          alert('Please fill in all range fields.');
          return;
        }
        const seatsToSelect = roomSeats.filter(seat => {
          const rowChar = seat.position.match(/[A-Z]/i)[0].toUpperCase();
          const colNum = parseInt(seat.position.match(/\d+/)[0]);
          return rowChar >= fromRow && rowChar <= toRow && colNum >= fromCol && colNum <= toCol;
        });
        seatsToSelect.forEach(seat => {
          const checkbox = document.getElementById('vip-check-' + seat.seatID);
          if (checkbox && !checkbox.checked) {
            checkbox.checked = true;
            checkbox.dispatchEvent(new Event('change', { bubbles: true }));
          }
        });
      }
      if (targetId === 'clearVipBtn') {
        document.querySelectorAll('.vip-checkbox-hidden:checked').forEach(checkbox => {
          checkbox.checked = false;
          checkbox.dispatchEvent(new Event('change', { bubbles: true }));
        });
      }
    });
  });

  /*]]>*/

</script>

</body>

</html>