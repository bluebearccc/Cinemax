<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food And Drink</title>
    <link rel="stylesheet" th:href="@{/staff/css/style.css}">

</head>

<body>
<!-- Sidebar -->
<div class="sidebar">
    <div class="user-info">
        <div class="user-avatar">M</div>
        <div class="user-name">Mary Johnson</div>
    </div>

    <a href="#" class="sidebar-item">
        <div class="sidebar-icon">üè†</div>
        <div class="sidebar-text">Home</div>
    </a>
    <a th:href="@{/theater_stock}" class="sidebar-item active">
        <div class="sidebar-icon">üçø</div>
        <div class="sidebar-text">Food and Drinks</div>
    </a>
    <a th:href="@{/movie_schedule}" class="sidebar-item ">
        <div class="sidebar-icon">üìÖ</div>
        <div class="sidebar-text">Set Schedule</div>
    </a>
    <a th:href="@{/theater}" class="sidebar-item ">
        <div class="sidebar-icon">üé¨</div>
        <div class="sidebar-text">Manage Theater</div>
    </a>
</div>

<!-- Main Content -->
<div class="main-content">
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <h1>Sale Report</h1>
        </div>
        <div class="header-actions">
            <a th:href="@{/theater_stock/export_to_excel(id=${param.id})}" class="btn btn-secondary">
                üì§ Dowload Excel File
            </a>
        </div>
    </div>

    <!-- Controls
    <div class="controls">
        <div class="search-box">
            <form th:action="@{/theater_stock/search}" method="get">
                <input type="hidden"/>
                <input type="text" name="itemName" class="search-input" placeholder="Search for items's name">
            </form>
        </div>
        <a class="navbar-brand" th:href="@{/theater_stock/add_stock}"><u>Add new item</u></a>
    </div> -->

    <!-- Table -->
    <div class="table-container">
        <table class="table">
            <thead class="text-primary">
            <th>InvoiceID</th>
            <th>Name</th>
            <th>Quantity Sold</th>
            <th>Date Sold</th>
            <th>TotalPrice</th>
            </thead>
            <tbody>
            <tr th:each="detail : ${detail_FDs}">
                <td th:text="${detail.getTheaterStockId()}"></td>
                <td th:text="${detail.itemName}"></td>
                <td th:text="${detail.quantity}"></td>
                <td th:text="${detail.getFormattedBookingDate()}"></td>
                <td th:text="${#numbers.formatCurrency(detail.getTotalPrice())}"></td>
            </tr>
            <!-- Hi·ªÉn th·ªã th√¥ng b√°o khi kh√¥ng c√≥ d·ªØ li·ªáu -->
            <tr th:if="${#lists.isEmpty(detail_FDs)}">
                <td colspan="6" class="text-center">No items sold found</td>
            </tr>
            </tbody>

        </table>

        <!-- Modal for Add/Edit Item -->
        <div id="itemModal" class="modal">
            <div class="modal-content">
                <button class="close-btn" onclick="closeModal()">&times;</button>
                <div class="modal-header">
                    <h4 class="modal-title" id="modalTitle">Add New Item</h4>
                    <p class="modal-subtitle">Complete the item information</p>
                </div>
                <div class="modal-body">
                    <form th:action="@{/theater_stock/process_stock}"
                          id="itemForm"
                          method="POST"
                          enctype="multipart/form-data">
                        <input type="hidden" id="stockId" name="stockId">
                        <input type="hidden" id="theaterID" th:value="${employee.theaterId}" name="theaterID">
                        <input type="hidden" id="currentImagePath" name="image">

                        <div class="form-row">
                            <!-- Left Column - General Information -->
                            <div class="form-column">
                                <!-- Theater -->
                                <div class="form-group">
                                    <label class="form-label">Theater</label>
                                </div>

                                <!-- Name -->
                                <div class="form-group">
                                    <label class="form-label">Name</label>
                                    <input type="text" class="form-input" id="itemName" name="itemName"
                                           maxlength="20" required>
                                    <div class="error-message" id="nameError"></div>
                                </div>

                                <!-- Quantity -->
                                <div class="form-group">
                                    <label class="form-label">Quantity</label>
                                    <input type="number" class="form-input" id="quantity" name="quantity" min="0"
                                           required>
                                    <div class="error-message" id="quantityError"></div>
                                </div>

                                <!-- Price -->
                                <div class="form-group">
                                    <label class="form-label">Price</label>
                                    <input type="number" step="0.01" class="form-input" id="price" name="price"
                                           min="0" max="99999999.99" required>
                                    <div class="error-message" id="priceError"></div>
                                </div>

                                <!-- Status -->
                                <div class="form-group">
                                    <label class="form-label">Set Status</label>
                                    <div class="radio-group">
                                        <div class="radio-item">
                                            <input type="radio" id="statusActive" name="status" value="Active"
                                                   checked>
                                            <label for="statusActive">Active</label>
                                        </div>
                                        <div class="radio-item">
                                            <input type="radio" id="statusInactive" name="status" value="Inactive">
                                            <label for="statusInactive">Inactive</label>
                                        </div>
                                    </div>
                                    <div class="error-message" id="statusError"></div>
                                </div>
                            </div>

                            <!-- Right Column - Image Upload -->
                            <div class="form-column">
                                <div class="form-group">
                                    <label class="form-label">Current Image:</label>
                                    <img id="currentImage" src="" alt="Current Image" class="current-image"
                                         style="display: none; max-width: 200px; max-height: 200px; border-radius: 8px;">
                                </div>

                                <!-- Image Upload -->
                                <div class="form-group">
                                    <label class="form-label">Upload New Image</label>
                                    <div class="image-upload-area"
                                         onclick="document.getElementById('imageInput').click()">
                                        <div>üì∏</div>
                                        <p>Click to upload or drag and drop</p>
                                        <small>PNG, JPG, GIF up to 10MB</small>
                                    </div>
                                    <input type="file" id="imageInput" name="imageInput" accept="image/*"
                                           style="display: none;" onchange="previewImage(this)">
                                    <div id="imagePreview" class="image-preview"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Buttons -->
                        <div class="form-buttons">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">Reset</button>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Show notification on page load if message exists
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-hide alert after 5 seconds
        const alert = document.querySelector('.alert');
        if (alert) {
            setTimeout(function() {
                alert.style.opacity = '0';
                setTimeout(function() {
                    alert.remove();
                }, 300);
            }, 5000);
        }
    });

    // Function to show toast notification
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
                ${message}
                <button class="close-btn" onclick="closeNotification(this)">&times;</button>
            `;

        document.body.appendChild(notification);

        // Show notification
        setTimeout(() => {
            notification.classList.add('show');
        }, 100);

        // Auto-hide after 5 seconds
        setTimeout(() => {
            closeNotification(notification.querySelector('.close-btn'));
        }, 5000);
    }

    function closeNotification(btn) {
        const notification = btn.parentElement;
        notification.classList.remove('show');
        setTimeout(() => {
            notification.remove();
        }, 300);
    }

    // Enhanced delete confirmation
    function confirmDelete(form, event) {
        event.preventDefault();

        if (confirm('Are you sure you want to delete this item?')) {
            // Show loading state
            const button = form.querySelector('button[type="submit"]');
            const originalText = button.textContent;
            button.textContent = 'Deleting...';
            button.disabled = true;

            // Submit form
            form.submit();

            // Reset button state after a delay (in case of error)
            setTimeout(() => {
                button.textContent = originalText;
                button.disabled = false;
            }, 3000);

            return true;
        }
        return false;
    }

    // Function ƒë·ªÉ x·ª≠ l√Ω form edit
    function handleEditForm(event) {
        event.preventDefault();
        const form = event.target;
        const stockId = form.querySelector('input[name="stockId"]').value;
        editItem(stockId);
        return false;
    }

    // Modal functionality
    function openModal(isEdit = false, data = null) {
        const modal = document.getElementById('itemModal');
        const modalTitle = document.getElementById('modalTitle');

        if (isEdit && data) {
            modalTitle.textContent = 'Edit Item';
            document.getElementById('stockId').value = data.stockId || '';
            document.getElementById('itemName').value = data.itemName || '';
            document.getElementById('quantity').value = data.quantity || '';
            document.getElementById('price').value = data.price || '';
            document.getElementById('currentImagePath').value = data.image || '';

            if (data.status === 'Active') {
                document.getElementById('statusActive').checked = true;
            } else {
                document.getElementById('statusInactive').checked = true;
            }

            if (data.image) {
                const currentImage = document.getElementById('currentImage');
                currentImage.src = data.image;
                currentImage.style.display = 'block';
            }
        } else {
            modalTitle.textContent = 'Add New Item';
            resetForm();
        }

        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        const modal = document.getElementById('itemModal');
        modal.classList.remove('show');
        document.body.style.overflow = 'auto';
        resetForm();
    }

    function resetForm() {
        document.getElementById('itemForm').reset();
        document.getElementById('stockId').value = '';
        document.getElementById('currentImagePath').value = '';
        document.getElementById('currentImage').style.display = 'none';
        document.getElementById('imagePreview').innerHTML = '';
        document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
        document.getElementById('statusActive').checked = true;
    }

    function editItem(stockId) {
        fetch(`/theater_stock/getItemData?stockId=${stockId}`)
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Item not found');
            })
            .then(data => {
                openModal(true, data);
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error loading item data', 'error');
            });
    }

    function previewImage(input) {
        const preview = document.getElementById('imagePreview');
        preview.innerHTML = '';

        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.maxWidth = '200px';
                img.style.maxHeight = '200px';
                img.style.borderRadius = '8px';
                img.style.objectFit = 'cover';
                preview.appendChild(img);
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // Close modal when clicking outside
    window.onclick = function (event) {
        const modal = document.getElementById('itemModal');
        if (event.target === modal) {
            closeModal();
        }
    }

    // Handle escape key
    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
            closeModal();
        }
    });

    // Drag and drop functionality
    const uploadArea = document.querySelector('.image-upload-area');

    uploadArea.addEventListener('dragover', function (e) {
        e.preventDefault();
        this.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', function (e) {
        e.preventDefault();
        this.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', function (e) {
        e.preventDefault();
        this.classList.remove('dragover');

        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].type.startsWith('image/')) {
            document.getElementById('imageInput').files = files;
            previewImage(document.getElementById('imageInput'));
        }
    });
</script>
</body>
</html>
