<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Schedule</title>
    <link rel="stylesheet" th:href="@{/staff/css/style.css}">
    <link rel="stylesheet" th:href="@{/staff/css/movie_schedule.css}">
    <style>
        .schedule-detail-item {
            margin-bottom: 15px;
            font-size: 16px;
        }
        .schedule-detail-item strong {
            display: inline-block;
            width: 100px;
            color: #555;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }

        .room-cards-wrapper {
            display: flex;
            flex-wrap: wrap; /* Cho ph√©p c√°c card t·ª± xu·ªëng d√≤ng n·∫øu kh√¥ng ƒë·ªß ch·ªó */
            gap: 12px; /* Kho·∫£ng c√°ch gi·ªØa c√°c card */
            margin-top: 8px;
        }

        .room-card {
            display: flex; /* S·∫Øp x·∫øp checkbox v√† label tr√™n c√πng m·ªôt h√†ng */
            align-items: center;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px 15px;
            background-color: #f9f9f9;
            transition: all 0.2s ease-in-out;
        }

        .room-card:hover {
            border-color: #007bff;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.15);
        }

        .room-checkbox {
            margin-right: 10px;
            /* TƒÉng k√≠ch th∆∞·ªõc checkbox cho d·ªÖ b·∫•m */
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .room-label {
            font-weight: 500;
            color: #333;
            cursor: pointer;
        }

        .no-rooms-message {
            color: #888;
            font-style: italic;
            padding: 15px;
            background-color: #f5f5f5;
            border: 1px dashed #ccc;
            border-radius: 5px;
            text-align: center;
        }
        /* Style cho message box */
        .message-box {
            padding: 10px 20px;
            margin-bottom: 20px;
            border-radius: 5px;
            font-weight: bold;
            text-align: center;
        }
        .message-box.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message-box.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Styles cho message box trong modal v√† c√°c ph·∫ßn t·ª≠ b·ªã disabled */
        .modal-message-box {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            font-weight: bold;
            text-align: center;
        }
        .modal-message-box.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .disabled-element {
            /* M·ªù ƒëi v√† kh√¥ng cho t∆∞∆°ng t√°c */
            opacity: 0.6;
            pointer-events: none;
            cursor: not-allowed;
        }
    </style>

</head>
<body>
<div class="sidebar">
    <div class="user-info">
        <div class="user-avatar" >M</div>
        <div class="user-name" >Mary Johnson</div>
    </div>

    <a href="#" class="sidebar-item">
        <div class="sidebar-icon">üè†</div>
        <div class="sidebar-text">Home</div>
    </a>
    <a th:href="@{/theater_stock}" class="sidebar-item">
        <div class="sidebar-icon">üçø</div>
        <div class="sidebar-text">Food and Drinks</div>
    </a>
    <a th:href="@{/movie_schedule}" class="sidebar-item  active">
        <div class="sidebar-icon">üìÖ</div>
        <div class="sidebar-text">Set Schedule</div>
    </a>
    <a th:href="@{/theater}" class="sidebar-item ">
        <div class="sidebar-icon">üé¨</div>
        <div class="sidebar-text">Manage Theater</div>
    </a>
</div>
<div class="main-content">
    <div class="header">
        <div class="movie-info">
            <div class="movie-poster">
                <img th:src="${movie.image}" alt="Movie Poster">
            </div>
            <div class="movie-details">
                <h1><span th:text="${movie.movieName}"></span></h1>
                <div class="movie-meta">
                    <div class="duration-badge">
                        Durations:<span th:text="${movie.duration}"></span> minutes
                    </div>
                </div>
                <div class="date-range-container">
                    <div class="date-range-label">
                        Screening Period
                    </div>
                    <div class="date-range-value">
                        <span th:text="${movie.formattedStartDate()}"></span> <span class="date-arrow">‚Üí</span> <span th:text="${movie.formattedEndDate()}"></span>
                    </div>
                </div>
            </div>
            <div>
                <button class="add-schedule-btn" onclick="addNewSchedule()">
                    + Add new Schedule
                </button>
            </div>
        </div>
    </div>

    <div class="schedule-section">
        <div class="schedule-header">
            <h2>Schedule</h2>
            <div class="calendar-nav">
                <button class="nav-btn" onclick="previousMonth()">‚Äπ</button>
                <span class="current-month" id="currentMonth">Th√°ng 6, 2025</span>
                <button class="nav-btn" onclick="nextMonth()">‚Ä∫</button>
            </div>
        </div>

        <div th:if="${message}" class="message-box" th:classappend="${message.contains('success') ? 'success' : 'error'}">
            <p th:text="${message}"></p>
        </div>

        <div class="calendar" id="calendar">
            <div class="calendar-header">Mo</div>
            <div class="calendar-header">Tu</div>
            <div class="calendar-header">We</div>
            <div class="calendar-header">Th</div>
            <div class="calendar-header">Fr</div>
            <div class="calendar-header">Sa</div>
            <div class="calendar-header">Su</div>

        </div>

        <div class="daily-schedule" id="dailySchedule">
            <div class="schedule-date"></div>
            <div class="schedule-list">
                <div class="schedule-item">
                    <div class="schedule-time"></div>
                    <div class="schedule-details">
                        <span class="room-info"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="scheduleModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">New Schedule</h3>
            <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>

        <form th:action="@{/movie_schedule/add_schedule}"  id="scheduleForm" method="POST" class="modal-body">
            <input type="hidden" name="movieId" id="movieId" th:value="${movie.getMovieID()}">
            <div class="form-group">
                <label class="form-label">Select Date</label>
                <div class="calendar-nav-mini">
                    <button type="button" class="nav-btn-mini" onclick="previousMonthMini()">‚Äπ</button>
                    <span class="current-month-mini" id="currentMonthMini"></span>
                    <button type="button" class="nav-btn-mini" onclick="nextMonthMini()">‚Ä∫</button>
                </div>
                <div class="mini-calendar" id="miniCalendar">
                </div>
                <input type="hidden" id="selectedDateInput" name="date">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="startTime">StartTime</label>
                    <input type="text"
                           id="startTime"
                           name="startTime"
                           class="form-input"
                           placeholder="HH:mm"
                           pattern="([01][0-9]|2[0-3]):[0-5][0-9]"
                           required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="theater">Theater</label>
                    <select class="form-select" id="theater" name="theater" required disabled>
                        <option value="">Select Theater</option>
                        <option  th:each="x : ${theatersCbBox}" th:text="${x.theaterName}"
                                 th:value="${x.theaterID}">
                        </option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <div class="room-list-container" id="room-list-container">
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-cancel" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-save">Save</button>
            </div>
        </form>
    </div>
</div>

<div id="editScheduleModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Edit Schedule</h3>
            <button class="close-btn" onclick="closeEditModal()">&times;</button>
        </div>
        <div id="editScheduleMessage" class="modal-message-box error" style="display: none;"></div>

        <form id="editScheduleForm" method="POST" action="/movie_schedule/update_schedule">
            <input type="hidden" name="movieID" id="movieIDUpdate" th:value="${movie.getMovieID()}">
            <input type="hidden" name="scheduleID" id="scheduleIDUpdate">
            <div class="form-group">
                <label class="form-label">Selected Date</label> <div class="calendar-nav-mini">
                <button type="button" class="nav-btn-mini disabled-btn">‚Äπ</button>
                <span class="current-month-mini" id="currentMonthMiniUpdate"></span>
                <button type="button" class="nav-btn-mini disabled-btn">‚Ä∫</button>
            </div>
                <div class="mini-calendar" id="miniCalendarUpdate" style="pointer-events: none; opacity: 0.7;">
                </div>
                <input type="text" id="selectedDateInputUpdate" name="dateUpdate" class="form-input" readonly> </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="startTimeUpdate">StartTime</label>
                    <input type="text"
                           id="startTimeUpdate"
                           name="startTimeUpdate" class="form-input"
                           placeholder="HH:mm"
                           pattern="([01][0-9]|2[0-3]):[0-5][0-9]"
                           readonly required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="theaterNameUpdate">Theater</label>
                    <input type="text" id="theaterNameUpdate" class="form-input" readonly>
                    <input type="hidden" id="theaterIdUpdate" name="theaterUpdate">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="roomNameUpdate">Room</label>
                    <input type="text" id="roomNameUpdate" class="form-input" readonly>
                    <input type="hidden" id="roomIdUpdate" name="selectedRoomIds">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="statusActive" name="statusUpdate" value="Active">
                            <label for="statusActive">Active</label>
                            <div class="radio-item">
                                <input type="radio" id="statusInactive" name="statusUpdate" value="Inactive">
                                <label for="statusInactive">Inactive</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-cancel" onclick="closeEditModal()">Cancel</button>
                <button type="submit" class="btn btn-save" id="saveChangesBtn">Save Changes</button>
                <button type="button" class="btn btn-delete" id="deleteScheduleBtn" onclick="deleteSchedule($('#scheduleIDUpdate').val())">Delete this schedule</button>
            </div>
        </form>
    </div>
</div>
<script th:inline="javascript">
    const serverData = {
        schedules: [(${schedules})],
    startTime: [[${startTime}]],
        endTime: [[${endTime}]]
    }
</script>
<script th:src="@{/staff/js/miniupdate_schedule.js}"></script>
<script th:src="@{/staff/js/schedule.js}"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script th:inline="javascript">
    $(function(){
        const dateInput = $('#selectedDateInput');
        const timeInput = $('#startTime');
        const theaterSelect = $('#theater');

        function updateTheaterState() {
            const selectedDate = dateInput.val();
            const startTime = timeInput.val();

            const timeRegex = /^([01][0-9]|2[0-3]):[0-5][0-9]$/;
            const isTimeValid = timeRegex.test(startTime);

            if (selectedDate && isTimeValid) {
                theaterSelect.prop('disabled', false);
            } else {
                theaterSelect.prop('disabled', true);
                theaterSelect.val('');
                theaterSelect.trigger('change');
            }
        }

        timeInput.on('input', updateTheaterState);
        dateInput.on('change', updateTheaterState);
        $('#theater').on('change', function(){
            var theater = $(this).val();
            var movieId = $('#movieId').val();
            var selectedDate = $('#selectedDateInput').val();
            var startTime = $('#startTime').val();
            if (theater) {
                // G·ª≠i y√™u c·∫ßu AJAX
                $.ajax({
                    type: 'GET',
                    url: '/movie_schedule/available_rooms_fragment',
                    data: {
                        theaterId: theater,
                        movieId: movieId,
                        date: selectedDate,
                        startTime: startTime
                    },
                    success: function(fragment) {
                        $('#room-list-container').html(fragment);
                    },
                    error: function() {
                        alert('Cannot get available rooms.');
                        $('#room-list-container').html('');
                    }
                });
            } else {
                $('#room-list-container').html('');
            }
        });
    });
</script>
<script>
    function deleteSchedule(scheduleId) {
        // ·∫®n m·ªçi th√¥ng b√°o l·ªói c≈© trong modal khi b·∫Øt ƒë·∫ßu thao t√°c m·ªõi
        $('#editScheduleMessage').hide().text('');

        if (confirm('Do you want to delete this schedule? This action cannot be undone.')) {
            $.ajax({
                type: 'POST', // ƒê·∫£m b·∫£o kh·ªõp v·ªõi Controller c·ªßa b·∫°n
                url: '/movie_schedule/delete_schedule',
                data: { scheduleId: scheduleId },
                success: function(response) {
                    if (response.success) {
                        alert('L·ªãch tr√¨nh ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng!');
                        closeEditModal(); // ƒê√≥ng modal sau khi x√≥a th√†nh c√¥ng
                        location.reload(); // T·∫£i l·∫°i trang ƒë·ªÉ c·∫≠p nh·∫≠t danh s√°ch l·ªãch
                    } else {
                        // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói t·ª´ server trong modal
                        $('#editScheduleMessage').text(response.message || 'Failed to delete schedule due to an unknown error.').show();
                        // alert('Failed to delete this schedule: ' + (response.message || 'Unidentified error.')); // C√≥ th·ªÉ d√πng alert thay th·∫ø
                    }
                },
                error: function(xhr, status, error) {
                    // X·ª≠ l√Ω l·ªói AJAX (l·ªói m·∫°ng, server error)
                    let errorMessage = 'An error occurred while deleting the schedule.';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage += ': ' + xhr.responseJSON.message;
                    } else if (error) {
                        errorMessage += ': ' + error;
                    }
                    $('#editScheduleMessage').text(errorMessage).show();
                    console.error('AJAX Error:', xhr.responseText);
                }
            });
        } else {
            // Ng∆∞·ªùi d√πng h·ªßy x√≥a
            $('#editScheduleMessage').text('Delete operation cancelled.').show();
        }
    }
</script>
</body>
</html>