<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Schedule</title>
    <link rel="stylesheet" th:href="@{/staff/css/style.css}">
    <link rel="stylesheet" th:href="@{/staff/css/movie_schedule.css}">
    <link rel="shortcut icon" th:href="@{/customer-static/images/logo/logo.png}" type="image/x-icon">
    <style>
        #editScheduleModal .modal-content {
            max-width: 800px; /* TƒÉng chi·ªÅu r·ªông t·ªëi ƒëa c·ªßa modal */
        }

        /* 2. D√†n c√°c tr∆∞·ªùng tr√™n c√πng m·ªôt h√†ng b·∫±ng Flexbox */
        #editScheduleForm .form-row.inline-fields {
            display: flex;
            gap: 20px; /* T·∫°o kho·∫£ng c√°ch gi·ªØa c√°c tr∆∞·ªùng */
            align-items: flex-end; /* CƒÉn ch·ªânh c√°c tr∆∞·ªùng theo ph√≠a d∆∞·ªõi */
        }

        /* 3. Cho ph√©p c√°c group co gi√£n linh ho·∫°t */
        #editScheduleForm .form-row.inline-fields .form-group {
            flex: 1; /* M·ªói tr∆∞·ªùng s·∫Ω chi·∫øm kh√¥ng gian b·∫±ng nhau */
            margin-bottom: 0; /* B·ªè margin d∆∞·ªõi v√¨ ƒë√£ c√≥ gap */
        }
    </style>

</head>
<body>
<div class="sidebar">
    <div class="user-info">
        <div class="user-avatar" th:text="${#strings.substring(name,0,1)}"></div>
        <div class="user-name" th:text="${name}"></div>
    </div>

    <a th:href="@{/staff/home}" class="sidebar-item">
        <div class="sidebar-icon">üè†</div>
        <div class="sidebar-text">Home</div>
    </a>
    <a th:href="@{/staff/theater_stock}" class="sidebar-item ">
        <div class="sidebar-icon">üçø</div>
        <div class="sidebar-text">Food and Drinks</div>
    </a>
    <a th:href="@{/staff/movie_schedule}" class="sidebar-item active">
        <div class="sidebar-icon">üìÖ</div>
        <div class="sidebar-text">Set Schedule</div>
    </a>
    <a th:href="@{/staff/theater}" class="sidebar-item">
        <div class="sidebar-icon">üé¨</div>
        <div class="sidebar-text">Manage Theater</div>
    </a>
</div>
<div class="main-content">
    <div class="header">
        <div class="movie-info">
            <div class="movie-poster">
                <img th:src="${movie.image}" alt="Movie Poster">
            </div>
            <div class="movie-details">
                <h1><span th:text="${movie.movieName}"></span></h1>
                <div class="movie-meta">
                    <div class="duration-badge">
                        Durations:<span th:text="${movie.duration}"></span> minutes
                    </div>
                </div>
                <div class="date-range-container">
                    <div class="date-range-label">
                        Screening Period
                    </div>
                    <div class="date-range-value">
                        <span th:text="${movie.formattedStartDate()}"></span> <span class="date-arrow">‚Üí</span> <span th:text="${movie.formattedEndDate()}"></span>
                    </div>
                </div>
            </div>
            <div>
                <button class="add-schedule-btn" onclick="addNewSchedule()">
                    + Add new Schedule
                </button>
            </div>
        </div>
    </div>

    <div class="schedule-section">
        <div class="schedule-header">
            <h2>Schedule</h2>
            <div class="calendar-nav">
                <button class="nav-btn" onclick="previousMonth()">‚Äπ</button>
                <span class="current-month" id="currentMonth">Th√°ng 6, 2025</span>
                <button class="nav-btn" onclick="nextMonth()">‚Ä∫</button>
            </div>
        </div>

        <div th:if="${message}" class="message-box" th:classappend="${message.contains('success') ? 'success' : 'error'}">
            <p th:text="${message}"></p>
        </div>

        <div class="calendar" id="calendar">
            <div class="calendar-header">Mo</div>
            <div class="calendar-header">Tu</div>
            <div class="calendar-header">We</div>
            <div class="calendar-header">Th</div>
            <div class="calendar-header">Fr</div>
            <div class="calendar-header">Sa</div>
            <div class="calendar-header">Su</div>

        </div>

        <div class="daily-schedule" id="dailySchedule">
            <div class="schedule-date"></div>
            <div class="schedule-list">
                <div class="schedule-item">
                    <div class="schedule-time"></div>
                    <div class="schedule-details">
                        <span class="room-info"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="scheduleModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">New Schedule</h3>
            <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>

        <form th:action="@{/staff/movie_schedule/add_schedule}"  id="scheduleForm" method="POST" class="modal-body">
            <input type="hidden" name="movieId" id="movieId" th:value="${movie.getMovieID()}">
            <div class="form-group">
                <label class="form-label">Select Date</label>
                <div class="calendar-nav-mini">
                    <button type="button" class="nav-btn-mini" onclick="previousMonthMini()">‚Äπ</button>
                    <span class="current-month-mini" id="currentMonthMini"></span>
                    <button type="button" class="nav-btn-mini" onclick="nextMonthMini()">‚Ä∫</button>
                </div>
                <div class="mini-calendar" id="miniCalendar">
                </div>
                <input type="hidden" id="selectedDateInput" name="date">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="startTime">StartTime</label>
                    <input type="text"
                           id="startTime"
                           name="startTime"
                           class="form-input"
                           placeholder="HH:mm"
                           pattern="([01][0-9]|2[0-3]):[0-5][0-9]"
                           required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="theater">Theater</label>
                    <select class="form-select" id="theater" name="theater" required disabled>
                        <option value="">Select Theater</option>
                        <option  th:each="x : ${theatersCbBox}" th:text="${x.theaterName}"
                                 th:value="${x.theaterID}">
                        </option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <div class="room-list-container" id="room-list-container">
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-cancel" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-save">Save</button>
            </div>
        </form>
    </div>
</div>

<div id="editScheduleModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Edit Schedule</h3>
            <button class="close-btn" onclick="closeEditModal()">&times;</button>
        </div>
        <div id="editScheduleMessage" class="modal-message-box error" style="display: none;"></div>

        <form id="editScheduleForm" method="POST" action="/staff/movie_schedule/update_schedule">
            <input type="hidden" name="movieID" id="movieIDUpdate" th:value="${movie.getMovieID()}">
            <input type="hidden" name="scheduleID" id="scheduleIDUpdate">
            <div class="form-group">
                <label class="form-label">Selected Date</label>
                <div class="calendar-nav-mini">
                    <button type="button" class="nav-btn-mini ">‚Äπ</button>
                    <span class="current-month-mini" id="currentMonthMiniUpdate"></span>
                    <button type="button" class="nav-btn-mini ">‚Ä∫</button>
                </div>
                <div class="mini-calendar" id="miniCalendarUpdate">
                </div>
                <input type="hidden" id="dateUpdateInput" name="dateUpdate">
            </div>
            <div class="form-row inline-fields">
                <div class="form-group">
                    <label class="form-label" for="startTimeUpdate">StartTime</label>
                    <input type="text"
                           id="startTimeUpdate"
                           name="startTimeUpdate" class="form-input"
                           placeholder="HH:mm"
                           pattern="([01][0-9]|2[0-3]):[0-5][0-9]"
                           required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="theaterNameUpdate">Theater</label>
                    <select id="theaterNameUpdate" name="theaterUpdate" class="form-select" required >
                        <option th:each="theater:${theatersCbBox}"
                                th:value="${theater.theaterID}"
                                th:text="${theater.theaterName}">
                        </option>
                    </select>
                </div>
            </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Room</label>
                        <div class="room-list-container" id="edit-room-list-container">
                        </div>
                    </div>
                </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Suspend the schedule</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="statusActive" name="statusUpdate" value="Active">
                            <label for="statusActive">No</label>
                            <div class="radio-item">
                                <input type="radio" id="statusInactive" name="statusUpdate" value="Inactive">
                                <label for="statusInactive">Yes</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-cancel" onclick="closeEditModal()">Cancel</button>
                <button type="button" class="btn btn-save" id="saveChangesBtn" onclick="updateScheduleAjax()">Save Changes</button>
                <button type="button" class="btn btn-delete" id="deleteScheduleBtn" onclick="deleteSchedule($('#scheduleIDUpdate').val())">Delete this schedule</button>
            </div>
        </form>
    </div>
</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script th:inline="javascript">
    const serverData = {
        schedules: [(${schedules})],
        startTime: [[${startTime}]],
        endTime: [[${endTime}]]
    }
</script>
<script th:src="@{/staff/js/miniupdate_schedule.js}"></script>
<script th:src="@{/staff/js/schedule.js}"></script>
<script th:inline="javascript">
    $(function(){
        const dateInput = $('#selectedDateInput');
        const timeInput = $('#startTime');
        const theaterSelect = $('#theater');

        function updateTheaterState() {
            const selectedDate = dateInput.val();
            const startTime = timeInput.val();

            const timeRegex = /^([01][0-9]|2[0-3]):[0-5][0-9]$/;
            const isTimeValid = timeRegex.test(startTime);

            if (selectedDate && isTimeValid) {
                theaterSelect.prop('disabled', false);
            } else {
                theaterSelect.prop('disabled', true);
                theaterSelect.val('');
                theaterSelect.trigger('change');
            }
        }

        timeInput.on('input', updateTheaterState);
        dateInput.on('change', updateTheaterState);
        $('#theater').on('change', function(){
            var theater = $(this).val();
            var movieId = $('#movieId').val();
            var selectedDate = $('#selectedDateInput').val();
            var startTime = $('#startTime').val();
            if (theater) {
                // G·ª≠i y√™u c·∫ßu AJAX
                $.ajax({
                    type: 'GET',
                    url: '/staff/movie_schedule/available_rooms_fragment',
                    data: {
                        theaterId: theater,
                        movieId: movieId,
                        date: selectedDate,
                        startTime: startTime
                    },
                    success: function(fragment) {
                        $('#room-list-container').html(fragment);
                    },
                    error: function() {
                        alert('Cannot get available rooms.');
                        $('#room-list-container').html('');
                    }
                });
            } else {
                $('#room-list-container').html('');
            }
        });
    });
</script>
<script>
    function deleteSchedule(scheduleId) {
        if (confirm('Do you want to delete this schedule? This action cannot be undone.')) {
            $.ajax({
                type: 'POST',
                url: '/staff/movie_schedule/delete_schedule',
                data: { scheduleId: scheduleId },
                success: function(response) {
                    if (response.success) {
                        alert('Schedule deleted successfully!');
                        closeEditModal();
                        location.reload();
                    } else {
                        // THAY ƒê·ªîI: Hi·ªÉn th·ªã th√¥ng b√°o l·ªói b·∫±ng alert
                        alert(response.message || 'Failed to delete schedule due to an unknown error.');
                    }
                },
                error: function(xhr, status, error) {
                    let errorMessage = 'An error occurred while deleting the schedule.';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage += ': ' + xhr.responseJSON.message;
                    }
                    // THAY ƒê·ªîI: Hi·ªÉn th·ªã th√¥ng b√°o l·ªói b·∫±ng alert
                    alert(errorMessage);
                    console.error('AJAX Error:', xhr.responseText);
                }
            });
        }
    }
</script>
<script>
    function updateScheduleAjax() {
        $('#saveChangesBtn').prop('disabled', false);

        const formData = $('#editScheduleForm').serialize();

        $.ajax({
            type: 'POST',
            url: '/staff/movie_schedule/update_schedule_ajax',
            data: formData,
            success: function(response) {
                if (response.success) {
                    alert(response.message);
                    closeEditModal();
                    location.reload();
                } else {
                    alert(response.message);
                }
            }
        });
    }
</script>
</body>
</html>