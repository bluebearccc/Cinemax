<!DOCTYPE html>

<html xmlns:th="http://www.thymeleaf.org" lang="vi">



<head>

  <meta charset="UTF-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Food And Drink</title>

  <link rel="stylesheet" th:href="@{/staff/css/style.css}">
  <link rel="stylesheet" th:href="@{/staff/css/add_update_item.css}">
  <link href='https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css' rel='stylesheet'/>
  <script src='https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js'></script>
  <style>
    .alert {
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid transparent;
      border-radius: 4px;
      font-size: 16px;
      text-align: center;
    }

    .alert-error {
      color: #a94442;
      background-color: #f2dede;
      border-color: #ebccd1;
    }

    .alert-success {
      color: #3c763d;
      background-color: #dff0d8;
      border-color: #d6e9c6;
    }
    #map {
      height: 400px;
      width: 100%;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .address-input-group {
      display: flex;
      align-items: center;
    }

    .address-input-group .form-input {
      flex-grow: 1;
      margin-right: 10px;
    }

    .address-input-group .search-button {
      flex-shrink: 0;
    }
  </style>
</head>



<body>
<div class="sidebar">
  <div class="user-info">
    <div class="user-avatar" th:text="${#strings.substring(employeeName,0,1)}"></div>
    <div class="user-name" th:text="${employeeName}"></div>
  </div>

  <a th:href="@{/staff/home}" class="sidebar-item">
    <div class="sidebar-icon">üè†</div>
    <div class="sidebar-text">Home</div>
  </a>
  <a th:href="@{/staff/theater_stock}" class="sidebar-item ">
    <div class="sidebar-icon">üçø</div>
    <div class="sidebar-text">Food and Drinks</div>
  </a>
  <a th:href="@{/staff/movie_schedule}" class="sidebar-item ">
    <div class="sidebar-icon">üìÖ</div>
    <div class="sidebar-text">Set Schedule</div>
  </a>
  <a th:href="@{/staff/theater}" class="sidebar-item active">
    <div class="sidebar-icon">üé¨</div>
    <div class="sidebar-text">Manage Theater</div>
  </a>
</div>
<div class="main-content">
  <div class="header">
    <div class="header-left">
      <div class="breadcrumb">
        <a href="#" th:href="@{/staff/theater}">Manage Theater</a> >
        <span> Add new theater</span>
      </div>
    </div>
  </div>
  <div th:if="${message}" class="alert" th:classappend="${messageType == 'success'} ? 'alert-success' : 'alert-error'">
    <span th:text="${message}"></span>
  </div>
  <div class="form-container">
    <div class="form-header">
      <p class="form-subtitle">Complete the item information</p>
    </div>
    <form th:action="@{/staff/theater/add_theater}"
          th:object="${theater}"
          method="post"
          enctype="multipart/form-data"
          id="stockForm"
          onsubmit="return validateForm()">
      <div class="form-row">
        <div class="form-column">

          <div class="form-group">
            <label class="form-label">Theater Name</label>
            <input type="text"
                   class="form-input"
                   th:field="*{theaterName}"
                   placeholder="Enter theater name begin with CGV"
                   required>
            <div class="error-message" id="nameError"></div>
          </div>

          <input type="hidden" name="name" />
          <input type="hidden" th:field="*{latitude}" id="latitude-field">
          <input type="hidden" th:field="*{longitude}" id="longitude-field">
          <div class="form-column">
            <div class="form-group">
              <label class="form-label">Theater Address</label>
              <div class="address-input-group">
                <input type="text"
                       class="form-input"
                       th:field="*{address}"
                       id="search-input"
                       placeholder="Enter theater address "
                       required>
                <button type="button" class="search-button" id="search-btn">Search</button>
              </div>
              <div class="error-message" id="addressError"></div>
              <div id="map"></div>
            </div>
            <div class="form-group">
              <label class="form-label">Set Availbility</label>
              <div class="radio-group">
                <div class="radio-item">
                  <input type="radio"
                         id="statusActive"
                         name="status"
                         value="Active"
                         th:field="*{status}"
                         th:checked="${theater.status == 'Active'}"
                         checked
                  >
                  <label for="statusActive">Active</label>
                </div>
                <div class="radio-item">
                  <input type="radio"
                         id="statusInactive"
                         name="status"
                         value="Inactive"
                         th:field="*{status}"
                         th:checked="${theater.status == 'Inactive'}">
                  <label for="statusInactive">Inactive</label>
                </div>

              </div>
              <div class="error-message" id="statusError"></div>
            </div>
          </div>
          <div class="form-column">
            <div class="form-group">
              <label class="form-label">Upload New Image</label>
              <div class="image-upload-area" onclick="document.getElementById('imageInput').click()">
                <div>üì∏</div>
                <p>Click to upload or drag and drop</p>
              </div>
              <input type="file"
                     id="imageInput"
                     name="imageInput"
                     accept="image/*"
                     style="display: none;"
                     onchange="previewImage(this)">

              <div id="imagePreview" class="image-preview"></div>
              <div class="error-message" id="imageError"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Save</button>
        <button type="reset" class="btn btn-secondary" onclick="resetForm()">Reset</button>
        <a th:href="@{/staff/theater}" class="btn btn-danger">Cancel</a>
      </div>
    </form>
  </div>
</div>

<script>
  function previewImage(input) {
    const preview = document.getElementById('imagePreview');
    preview.innerHTML = '';
    if (input.files && input.files[0]) {
      const file = input.files[0];
      if (!file.type.startsWith('image/')) {
        alert('Please upload an image file');
        input.value = '';
        return;
      }
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = document.createElement('img');
        img.src = e.target.result;
        img.style.maxWidth = '100%';
        img.style.borderRadius = '8px';
        preview.appendChild(img);
      };
      reader.readAsDataURL(file);
    }
  }

  function resetForm() {
    document.getElementById('stockForm').reset();
    document.getElementById('imagePreview').innerHTML = '';
    document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
    document.getElementById('statusActive').checked = true;
  }

  function validateForm() {
    let isValid = true;
    document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
    const theaterNameInput = document.querySelector('input[name="theaterName"]');
    const addressInput = document.querySelector('input[name="address"]');
    const statusInput = document.querySelector('input[name="status"]:checked');
    const imageInput = document.getElementById('imageInput');

    if (theaterNameInput.value.trim() === '') {
      document.getElementById('nameError').textContent = 'Theater Name is required.';
      isValid = false;
    } else if (!theaterNameInput.value.trim().toLowerCase().startsWith('cgv')) {
      document.getElementById('nameError').textContent = 'Theater Name must begin with "CGV".';
      isValid = false;
    }
    if (addressInput.value.trim() === '') {
      document.getElementById('addressError').textContent = 'Address is required.';
      isValid = false;
    }
    if (!statusInput) {
      document.getElementById('statusError').textContent = 'Please select an availability status.';
      isValid = false;
    }
    if (imageInput.files.length === 0) {
      document.getElementById('imageError').textContent = 'Please upload an image for the theater.';
      isValid = false;
    }
    return isValid;
  }

</script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Kh·ªüi t·∫°o b·∫£n ƒë·ªì
    mapboxgl.accessToken = 'pk.eyJ1IjoiYmx1ZWJlYXIxMjMiLCJhIjoiY21jcnQzYzVqMDZkNjJvczkyem5qcDYyNCJ9.4qcFRtXFMsoTuDCxr1aMyw';
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v12',
      center: [105.84, 21.02],
      zoom: 10
    });

    const searchInput = document.getElementById('search-input');
    const searchBtn = document.getElementById('search-btn');
    const longitudeField = document.getElementById('longitude-field');
    const latitudeField = document.getElementById('latitude-field');

    let currentMarker = null;

    searchBtn.addEventListener('click', function() {
      const address = searchInput.value.trim();
      if (address) {
        searchAddress(address);
      } else {
        alert('Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ ƒë·ªÉ t√¨m ki·∫øm.');
      }
    });

    searchInput.addEventListener('keypress', function(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        searchBtn.click();
      }
    });

    map.on('click', function(e) {
      const { lng, lat } = e.lngLat;
      addDraggableMarker(lat, lng, 'V·ªã tr√≠ ƒë∆∞·ª£c ch·ªçn');
      reverseGeocode(lat, lng);
    });

    function searchAddress(address) {
      const encodedAddress = encodeURIComponent(address);
      fetch(`/staff/theater/search/${encodedAddress}`)
              .then(response => {
                if (response.ok) return response.json();
                throw new Error('Address not found');
              })
              .then(location => {
                addDraggableMarker(location.lat, location.lng, location.placeName);
                updateLocationInfo(location.placeName, location.lat, location.lng);
              })
              .catch(error => {
                console.error('L·ªói t√¨m ki·∫øm:', error);
                alert('Kh√¥ng t√¨m th·∫•y ƒë·ªãa ch·ªâ b·∫°n y√™u c·∫ßu.');
              });
    }

    function addDraggableMarker(lat, lng, placeName) {
      if (currentMarker) {
        currentMarker.remove();
      }
      currentMarker = new mapboxgl.Marker({
        color: '#d9534f',
        draggable: true
      })
              .setLngLat([lng, lat])
              .setPopup(new mapboxgl.Popup().setText(placeName))
              .addTo(map);

      currentMarker.on('dragend', function() {
        const newLngLat = currentMarker.getLngLat();
        console.log('Marker ƒë∆∞·ª£c di chuy·ªÉn t·ªõi:', newLngLat);
        reverseGeocode(newLngLat.lat, newLngLat.lng);
        currentMarker.getPopup().setText('V·ªã tr√≠ ƒë√£ ch·ªçn');
      });

      map.flyTo({
        center: [lng, lat],
        zoom: 17
      });
      updateLocationInfo(placeName, lat, lng);
    }

    function reverseGeocode(lat, lng) {
      const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${lng},${lat}.json?access_token=${mapboxgl.accessToken}&country=VN&language=vi`;

      fetch(url)
              .then(response => response.json())
              .then(data => {
                if (data.features && data.features.length > 0) {
                  const placeName = data.features[0].place_name;
                  updateLocationInfo(placeName, lat, lng);
                  if (currentMarker) {
                    currentMarker.getPopup().setText(placeName);
                  }
                } else {
                  updateLocationInfo('Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c ƒë·ªãa ch·ªâ', lat, lng);
                }
              })
              .catch(error => {
                console.error('L·ªói reverse geocoding:', error);
                updateLocationInfo('Kh√¥ng th·ªÉ l·∫•y th√¥ng tin ƒë·ªãa ch·ªâ', lat, lng);
              });
    }

    function updateLocationInfo(placeName, lat, lng) {
      // C·∫≠p nh·∫≠t c√°c tr∆∞·ªùng ·∫©n ch·ª©a t·ªça ƒë·ªô
      longitudeField.value = lng.toFixed(6);
      latitudeField.value = lat.toFixed(6);
      document.getElementById('search-input').value = placeName;
      console.log('ƒê√£ c·∫≠p nh·∫≠t t·ªça ƒë·ªô v√† ƒë·ªãa ch·ªâ:', {
        address: placeName,
        longitude: lng.toFixed(6),
        latitude: lat.toFixed(6)
      });
    }

    // Th√™m controls cho b·∫£n ƒë·ªì
    map.addControl(new mapboxgl.NavigationControl());
    map.addControl(new mapboxgl.FullscreenControl());
    map.addControl(new mapboxgl.ScaleControl({
      maxWidth: 80,
      unit: 'metric'
    }));

    document.querySelector('form').addEventListener('submit', function(event) {
      const lng = longitudeField.value;
      const lat = latitudeField.value;

      if (!lng || !lat) {
        event.preventDefault();
        alert('Please select a location on the map or enter an address.');
        return false;
      }
    });
  });

</script>
</body>
</html>