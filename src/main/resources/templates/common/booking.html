<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <title>Đặt vé xem phim</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/booking.css}">
</head>
<body>
<!-- Animated background particles -->
<div class="bg-particles">
    <div class="particle" style="left: 10%; animation-delay: 0s;"></div>
    <div class="particle" style="left: 20%; animation-delay: 2s;"></div>
    <div class="particle" style="left: 30%; animation-delay: 4s;"></div>
    <div class="particle" style="left: 40%; animation-delay: 6s;"></div>
    <div class="particle" style="left: 50%; animation-delay: 8s;"></div>
    <div class="particle" style="left: 60%; animation-delay: 10s;"></div>
    <div class="particle" style="left: 70%; animation-delay: 12s;"></div>
    <div class="particle" style="left: 80%; animation-delay: 14s;"></div>
    <div class="particle" style="left: 90%; animation-delay: 16s;"></div>
</div>

<div class="main-container">
    <div class="booking-card">
        <div class="header-section">
            <h1 class="header-title">
                <i class="fas fa-film me-3"></i>Đặt vé xem phim
            </h1>
            <p class="header-subtitle">Trải nghiệm điện ảnh đỉnh cao - Chọn ghế yêu thích</p>
        </div>

        <div class="content-section">
            <form th:action="@{/booking/step1}" method="post">
                <input type="hidden" name="scheduleId" th:value="${scheduleId}" />
                <input type="hidden" name="roomId" th:value="${roomId}" />
                <input type="hidden" name="selectedSeats" th:each="seatId : ${selectedSeats}" th:value="${seatId}"/>
                <!-- Promotion Code Section -->
                <div class="promo-section">
                    <label class="promo-label">
                        <i class="fas fa-gift"></i>Mã giảm giá đặc biệt
                    </label>
                    <div class="input-group promo-input-group">
                        <input type="text"
                               name="promotionCode"
                               id="promotionCode"
                               class="form-control promo-input"
                               placeholder="Nhập mã để nhận ưu đãi hấp dẫn" />
                        <button type="button" id="applyPromoBtn" class="btn promo-btn">
                            <i class="fas fa-magic me-2"></i>Áp dụng
                        </button>
                    </div>
                    <div id="promoMessage" class="promo-message" style="display: none;"></div>
                </div>

                <!-- Screen Section -->
                <div class="screen-section">
                    <div class="screen">
                        <div class="screen-text">
                            <i class="fas fa-tv me-3"></i>MÀN HÌNH CHIẾU
                        </div>
                    </div>
                </div>

                <!-- Seat Selection Section -->
                <div class="seat-section">
                    <h3 class="seat-section-title">
                        <i class="fas fa-couch"></i>Chọn ghế của bạn
                    </h3>

                    <div th:each="entry : ${seatMap}" class="seat-row fade-in">
                        <div class="row-label" th:text="${entry.key}">A</div>
                        <div class="seat-container">
                            <div th:each="seat : ${entry.value}">
                                <input type="checkbox"
                                       class="btn-check"
                                       name="selectedSeats"
                                       th:value="${seat.seatId}"
                                       th:disabled="${seat.booked}"
                                       th:id="'seat-' + ${seat.seatId}"
                                       th:attr="data-price=${seat.unitPrice}, data-position=${seat.position}" />
                                <label th:for="'seat-' + ${seat.seatId}"
                                       class="seat seat-available"
                                       th:classappend="${seat.booked} ? 'seat-booked' : ''"
                                       th:text="${#strings.substring(seat.position, 1)}">1</label>
                            </div>

                        </div>
                    </div>

                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-seat legend-available"></div>
                            <span>Ghế trống</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-seat legend-selected"></div>
                            <span>Ghế đã chọn</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-seat legend-booked"></div>
                            <span>Ghế đã đặt</span>
                        </div>
                    </div>
                </div>
                <!-- Selected Seats Summary -->
                <div class="selected-seats-section mt-4">
                    <h4><i class="fas fa-couch"></i> Ghế đã chọn:</h4>
                    <div class="selected-seats-box mt-2">
                        <span id="selectedSeatsList" class="text-seat">Chưa có ghế nào</span>
                        <button type="button" id="clearSeatsBtn" class="btn-close-custom" aria-label="Clear"></button>
                    </div>
                </div>


                <!-- Total Section -->
                <div class="total-section">
                    <div class="total-label">
                        <i class="fas fa-calculator me-2"></i>Tổng thanh toán:
                    </div>
                    <div id="totalAmount" class="total-amount">0 ₫</div>
                </div>

                <!-- Continue Button -->
                <button type="submit" class="continue-btn">
                    <i class="fas fa-arrow-right me-2"></i>Tiếp tục đặt vé
                </button>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    let seatPrices = {};
    let currentDiscount = 0;

    // Initialize seat prices
    document.querySelectorAll('input[name="selectedSeats"]').forEach(cb => {
        const price = parseFloat(cb.getAttribute('data-price'));
        seatPrices[cb.value] = price;
    });

    function calculateTotal() {
        let total = 0;
        document.querySelectorAll('input[name="selectedSeats"]:checked').forEach(cb => {
            total += seatPrices[cb.value] || 0;
        });
        return total;
    }

    function updateTotalDisplay(total, discount = 0) {
        const totalAfterDiscount = Math.max(total - discount, 0);
        document.getElementById('totalAmount').textContent = new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
        }).format(totalAfterDiscount);
    }

    // Handle seat selection
    document.querySelectorAll('input[name="selectedSeats"]').forEach(cb => {
        cb.addEventListener('change', function() {
            const label = document.querySelector(`label[for="${this.id}"]`);

            if (this.checked) {
                label.classList.add('seat-selected');
                label.classList.remove('seat-available');
            } else {
                label.classList.remove('seat-selected');
                label.classList.add('seat-available');
            }

            const total = calculateTotal();
            updateTotalDisplay(total, currentDiscount);
            updateSelectedSeatsDisplay();
        });
    });

    // Handle promotion code
    document.getElementById('applyPromoBtn').addEventListener('click', function() {
        const promoCode = document.getElementById('promotionCode').value;
        const totalAmount = calculateTotal();

        if (!promoCode.trim()) {
            showPromoMessage('Vui lòng nhập mã giảm giá!', false);
            return;
        }

        this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang xử lý...';
        this.disabled = true;

        // Simulate API call
        setTimeout(() => {
            // Mock response - replace with actual API call
            const mockResponse = {
                valid: promoCode.toUpperCase() === 'DISCOUNT10',
                discount: promoCode.toUpperCase() === 'DISCOUNT10' ? totalAmount * 0.1 : 0,
                message: promoCode.toUpperCase() === 'DISCOUNT10' ?
                    'Áp dụng mã giảm giá thành công! Giảm 10%' :
                    'Mã giảm giá không hợp lệ'
            };

            if (mockResponse.valid) {
                currentDiscount = mockResponse.discount;
                showPromoMessage(mockResponse.message, true);
            } else {
                currentDiscount = 0;
                showPromoMessage(mockResponse.message, false);
            }

            updateTotalDisplay(totalAmount, currentDiscount);

            this.innerHTML = '<i class="fas fa-magic me-2"></i>Áp dụng';
            this.disabled = false;
        }, 1500);
    });

    function showPromoMessage(message, isSuccess) {
        const promoMessage = document.getElementById('promoMessage');
        promoMessage.textContent = message;
        promoMessage.style.display = 'block';
        promoMessage.classList.remove('success', 'error');
        promoMessage.classList.add(isSuccess ? 'success' : 'error');
    }
    function updateSelectedSeatsDisplay() {
        const selectedSeats = Array.from(document.querySelectorAll('input[name="selectedSeats"]:checked'))
            .map(cb => cb.getAttribute('data-position'));
        document.getElementById('selectedSeatsList').textContent = selectedSeats.length > 0
            ? selectedSeats.join(', ')
            : 'Chưa có ghế nào được chọn';
    }

    // Xử lý nút "Xóa tất cả ghế đã chọn"
    document.getElementById('clearSeatsBtn').addEventListener('click', function () {
        document.querySelectorAll('input[name="selectedSeats"]:checked').forEach(cb => {
            cb.checked = false;
            const label = document.querySelector(`label[for="${cb.id}"]`);
            if (label) {
                label.classList.remove('seat-selected');
                label.classList.add('seat-available');
            }
        });

        const total = calculateTotal();
        updateTotalDisplay(total, currentDiscount);
        updateSelectedSeatsDisplay();
    });

    // Handle form submission
    document.querySelector('form').addEventListener('submit', function(e) {
        const selectedSeats = document.querySelectorAll('input[name="selectedSeats"]:checked');
        if (selectedSeats.length === 0) {
            e.preventDefault();
            alert('Vui lòng chọn ít nhất một ghế trước khi tiếp tục!');
            return false;
        }
    });

    // Initialize animations
    setTimeout(() => {
        document.querySelectorAll('.seat-row').forEach((row, index) => {
            setTimeout(() => {
                row.classList.add('fade-in');
            }, index * 100);
        });
    }, 500);

    // Initialize total display
    updateTotalDisplay(0);

</script>
</body>
</html>