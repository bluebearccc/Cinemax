<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <title>Đặt vé xem phim</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/booking.css}">
</head>
<body>
<!-- Animated background particles -->
<div class="bg-particles">
    <div class="particle" style="left: 10%; animation-delay: 0s;"></div>
    <div class="particle" style="left: 20%; animation-delay: 2s;"></div>
    <div class="particle" style="left: 30%; animation-delay: 4s;"></div>
    <div class="particle" style="left: 40%; animation-delay: 6s;"></div>
    <div class="particle" style="left: 50%; animation-delay: 8s;"></div>
    <div class="particle" style="left: 60%; animation-delay: 10s;"></div>
    <div class="particle" style="left: 70%; animation-delay: 12s;"></div>
    <div class="particle" style="left: 80%; animation-delay: 14s;"></div>
    <div class="particle" style="left: 90%; animation-delay: 16s;"></div>
</div>

<div class="main-container">
    <div class="booking-card">
        <div class="header-section">
            <h1 class="header-title">
                <i class="fas fa-film me-3"></i>Đặt vé xem phim
            </h1>
            <p class="header-subtitle">Trải nghiệm điện ảnh đỉnh cao - Chọn ghế yêu thích</p>
        </div>

        <div class="content-section">
            <form th:action="@{/booking/step1}" method="post">
                <input type="hidden" name="scheduleId" th:value="${scheduleId}" />
                <input type="hidden" name="roomId" th:value="${roomId}" />

                <input type="hidden" name="selectedSeats" th:each="seatId : ${selectedSeats}" th:value="${seatId}"/>
                <!-- Promotion Code Section -->
                <div class="promo-section">
                    <label class="promo-label">
                        <i class="fas fa-gift"></i>Mã giảm giá đặc biệt
                    </label>
                    <div class="input-group promo-input-group">
                        <input type="text"
                               name="promotionCode"
                               id="promotionCode"
                               class="form-control promo-input"
                               placeholder="Nhập mã để nhận ưu đãi hấp dẫn" />
                        <button type="button" id="applyPromoBtn" class="btn promo-btn">
                            <i class="fas fa-magic me-2"></i>Áp dụng
                        </button>
                    </div>
                    <div id="promoMessage" class="promo-message" style="display: none;"></div>
                </div>

                <!-- Screen Section -->
                <div class="screen-section">
                    <div class="screen">
                        <div class="screen-text">
                            <i class="fas fa-tv me-3"></i>MÀN HÌNH CHIẾU
                        </div>
                    </div>
                </div>

                <!-- Seat Selection Section -->
                <div class="seat-section">
                    <h3 class="seat-section-title">
                        <i class="fas fa-couch"></i>Chọn ghế của bạn
                    </h3>

                    <div th:each="entry : ${seatMap}" class="seat-row fade-in">
                        <div class="row-label" th:text="${entry.key}">A</div>
                        <div class="seat-container">
                            <div th:each="seat, stat : ${entry.value}">
                                <!-- lấy phần tử bên cạnh: seatNext -->
                                <!--<th:block th:if="${seat.seatType == 'Couple'}"
                                          th:with="seatNext=${stat.index + 1 < entry.value.size()} ? ${entry.value[stat.index + 1]} : null">

                                    <div class="seat-couple-wrapper">
                                        <input type="checkbox"
                                               class="btn-check couple-seat"
                                               name="selectedSeats"
                                               th:id="'seat-couple-' + ${seat.seatId}"
                                               th:attr="data-seatid1=${seat.seatId}, data-seatid2=${seatNext != null ? seatNext.seatId : 0},
                            data-price1=${seat.unitPrice}, data-price2=${seatNext != null ? seatNext.unitPrice : 0}" />
                                        <label th:for="'seat-couple-' + ${seat.seatId}"
                                               class="seat seat-couple"
                                               th:text="${seat.position + (seatNext != null ? ' + ' + seatNext.position : '')}">C</label>
                                    </div>
                                </th:block>-->

                                <!-- Ghế đơn -->
                                <div th:if="${seat.seatType != 'couple'}" th:remove="tag">
                                    <input type="checkbox"
                                           class="btn-check"
                                           name="selectedSeats"
                                           th:value="${seat.seatID}"
                                           th:disabled="${seat.booked}"
                                           th:id="'seat-' + ${seat.seatID}"
                                           th:attr="data-price=${seat.unitPrice}, data-position=${seat.position}" />
                                    <label th:for="'seat-' + ${seat.seatID}"
                                           class="seat seat-available"
                                           th:classappend="(${seat.booked} ? 'seat-booked ' : '') + (${seat.isVIP} ? 'seat-vip' : '')"
                                           th:text="${#strings.substring(seat.position, 1)}">1</label>
                                </div>
                            </div>

                        </div>
                    </div>


                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-seat legend-isVIP"></div>
                            <span>ghế VIP</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-seat legend-available"></div>
                            <span>Ghế trống</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-seat legend-selected"></div>
                            <span>Ghế đã chọn</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-seat legend-booked"></div>
                            <span>Ghế đã đặt</span>
                        </div>
                    </div>
                </div>
                <!-- Selected Seats Summary -->
                <div class="selected-seats-section mt-4">
                    <h4><i class="fas fa-couch"></i> Ghế đã chọn:</h4>
                    <div class="selected-seats-box mt-2">
                        <span id="selectedSeatsList" class="text-seat">Chưa có ghế nào</span>
                        <button type="button" id="clearSeatsBtn" class="btn-close-custom" aria-label="Clear"></button>
                    </div>
                </div>

                <!-- Total Section -->
                <div class="total-section">
                    <div class="total-label">
                        <i class="fas fa-calculator me-2"></i>Tổng thanh toán:
                    </div>
                    <div id="totalAmount" class="total-amount">0 ₫</div>
                    <div id="detailedBreakdown" class="detailed-breakdown mt-2"></div>
                </div>


                <!-- Continue Button -->
                <button type="submit" class="continue-btn">
                    <i class="fas fa-arrow-right me-2"></i>Tiếp tục đặt vé
                </button>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    let seatPrices = {};
    let currentDiscount = 0;

    // Khởi tạo giá ghế đơn
    document.querySelectorAll('input[name="selectedSeats"]').forEach(cb => {
        const price = parseFloat(cb.getAttribute('data-price'));
        seatPrices[cb.value] = price;
    });

    function calculateTotal() {
        let total = 0;
        // Ghế đơn
        document.querySelectorAll('input[name="selectedSeats"]:checked').forEach(cb => {
            total += seatPrices[cb.value] || 0;
        });
        // Ghế đôi
        document.querySelectorAll('.couple-seat:checked').forEach(cb => {
            const price1 = parseFloat(cb.getAttribute('data-price1')) || 0;
            const price2 = parseFloat(cb.getAttribute('data-price2')) || 0;
            total += price1 + price2;
        });
        return total;
    }

    function calculateDetailedBreakdown() {
        const breakdown = {};
        // Ghế đơn
        document.querySelectorAll('input[name="selectedSeats"]:checked').forEach(cb => {
            const price = parseFloat(cb.getAttribute('data-price'));
            breakdown[price] = (breakdown[price] || 0) + 1;
        });
        // Ghế đôi
        document.querySelectorAll('.couple-seat:checked').forEach(cb => {
            const price1 = parseFloat(cb.getAttribute('data-price1'));
            const price2 = parseFloat(cb.getAttribute('data-price2'));
            breakdown[price1] = (breakdown[price1] || 0) + 1;
            breakdown[price2] = (breakdown[price2] || 0) + 1;
        });
        return breakdown;
    }

    function updateSelectedSeatsDisplay() {
        const selectedSingleSeats = Array.from(document.querySelectorAll('input[name="selectedSeats"]:checked'))
            .map(cb => cb.getAttribute('data-position'));
        const selectedCoupleSeats = Array.from(document.querySelectorAll('.couple-seat:checked'))
            .map(cb => {
                const pos1 = cb.getAttribute('data-seatid1');
                const pos2 = cb.getAttribute('data-seatid2');
                return `Ghế đôi (${cb.labels[0].innerText})`;
            });

        const combined = selectedSingleSeats.concat(selectedCoupleSeats);
        document.getElementById('selectedSeatsList').textContent = combined.length > 0
            ? combined.join(', ')
            : 'Chưa có ghế nào được chọn';
    }

    function updateTotalDisplay(total, discount = 0) {
        const totalAfterDiscount = Math.max(total - discount, 0);
        const breakdown = calculateDetailedBreakdown();
        const detailedBreakdownElement = document.getElementById('detailedBreakdown');

        document.getElementById('totalAmount').textContent = new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
        }).format(totalAfterDiscount);

        let breakdownHtml = '';
        for (const [price, count] of Object.entries(breakdown)) {
            breakdownHtml += `
                <div>${new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(price)} x ${count}</div>`;
        }
        /*breakdownHtml += `<div>= ${new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
        }).format(total)}</div>`;*/

        detailedBreakdownElement.innerHTML = breakdownHtml;
    }

    // Xử lý checkbox ghế đơn
    document.querySelectorAll('input[name="selectedSeats"]').forEach(cb => {
        cb.addEventListener('change', function() {
            const label = document.querySelector(`label[for="${this.id}"]`);
            if (this.checked) {
                label.classList.add('seat-selected');
                label.classList.remove('seat-available');
            } else {
                label.classList.remove('seat-selected');
                label.classList.add('seat-available');
            }

            const total = calculateTotal();
            updateTotalDisplay(total, currentDiscount);
            updateSelectedSeatsDisplay();
        });
    });

    // Xử lý checkbox ghế đôi
    document.querySelectorAll('.couple-seat').forEach(cb => {
        cb.addEventListener('change', function() {
            const label = document.querySelector(`label[for="${this.id}"]`);
            if (this.checked) {
                label.classList.add('seat-selected');
            } else {
                label.classList.remove('seat-selected');
            }

            const total = calculateTotal();
            updateTotalDisplay(total, currentDiscount);
            updateSelectedSeatsDisplay();
        });
    });

    // Xử lý nút áp dụng mã khuyến mãi
    document.getElementById('applyPromoBtn').addEventListener('click', function() {
        const promoCode = document.getElementById('promotionCode').value;
        const totalAmount = calculateTotal();

        if (!promoCode.trim()) {
            showPromoMessage('Vui lòng nhập mã giảm giá!', false);
            return;
        }

        this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang xử lý...';
        this.disabled = true;

        // Giả lập gọi API
        setTimeout(() => {
            const mockResponse = {
                valid: promoCode.toUpperCase() === 'DISCOUNT10',
                discount: promoCode.toUpperCase() === 'DISCOUNT10' ? totalAmount * 0.1 : 0,
                message: promoCode.toUpperCase() === 'DISCOUNT10'
                    ? 'Áp dụng mã giảm giá thành công! Giảm 10%'
                    : 'Mã giảm giá không hợp lệ'
            };

            currentDiscount = mockResponse.discount;
            showPromoMessage(mockResponse.message, mockResponse.valid);

            updateTotalDisplay(totalAmount, currentDiscount);

            this.innerHTML = '<i class="fas fa-magic me-2"></i>Áp dụng';
            this.disabled = false;
        }, 1500);
    });

    function showPromoMessage(message, isSuccess) {
        const promoMessage = document.getElementById('promoMessage');
        promoMessage.textContent = message;
        promoMessage.style.display = 'block';
        promoMessage.classList.remove('success', 'error');
        promoMessage.classList.add(isSuccess ? 'success' : 'error');
    }

    document.getElementById('clearSeatsBtn').addEventListener('click', function () {
        document.querySelectorAll('input:checked').forEach(cb => {
            cb.checked = false;
            const label = document.querySelector(`label[for="${cb.id}"]`);
            if (label) {
                label.classList.remove('seat-selected');
                label.classList.add('seat-available');
            }
        });

        const total = calculateTotal();
        updateTotalDisplay(total, currentDiscount);
        updateSelectedSeatsDisplay();
    });

    document.querySelector('form').addEventListener('submit', function(e) {
        const hasAnySeatSelected = document.querySelectorAll('input:checked').length > 0;
        if (!hasAnySeatSelected) {
            e.preventDefault();
            alert('Vui lòng chọn ít nhất một ghế trước khi tiếp tục!');
        }
    });

    updateTotalDisplay(0);
</script>

</body>
</html>