<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Hồ sơ người dùng - Cinema</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/profile.css}">
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
</div>

<!-- Header -->
<header class="header">
  <div class="container">
    <a href="#" class="logo">
      <i class="fas fa-film"></i>
      Cinema
    </a>
    <nav>
      <ul class="nav-links">
        <li><a href="#"><i class="fas fa-home me-1"></i>Trang chủ</a></li>
        <li><a href="#"><i class="fas fa-film me-1"></i>Phim</a></li>
        <li><a href="#"><i class="fas fa-calendar me-1"></i>Lịch chiếu</a></li>
        <li><a href="#"><i class="fas fa-user me-1"></i>Hồ sơ</a></li>
        <li><a href="#"><i class="fas fa-sign-out-alt me-1"></i>Đăng xuất</a></li>
      </ul>
    </nav>
  </div>
</header>

<!-- Main Content -->
<main class="main-content">
  <div class="container">
    <!-- Profile Header - Full Width -->
    <div class="profile-header">
      <h1><i class="fas fa-user-circle me-3"></i>Hồ sơ thành viên</h1>
      <p>Quản lý thông tin cá nhân và lịch sử xem phim</p>

      <!-- Account Information -->
      <div class="row mt-4">
        <div class="col-md-6">
          <div class="info-row">
            <div class="info-label">
              <i class="fas fa-envelope"></i>
              Email:
            </div>
            <div class="info-value" th:text="${account.email}">example@gmail.com</div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="info-row">
            <div class="info-label">
              <i class="fas fa-check-circle"></i>
              Trạng thái
            </div>
            <div class="info-value">
              <span class="status-badge status-active" th:text="${account.status}">Hoạt động</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Profile Layout - 2 Columns -->
    <div class="profile-layout">
      <!-- Left Column: History & Rewards -->
      <div class="profile-card">
        <div class="card-header-custom">
          <i class="fas fa-film"></i>
          Lịch sử & Ưu đãi
        </div>
        <div class="card-body-custom p-0">
          <ul class="nav nav-tabs" id="profileTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="tab-history" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">
                <i class="fas fa-ticket-alt me-2"></i>Lịch sử đặt vé
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab-points" data-bs-toggle="tab" data-bs-target="#points" type="button" role="tab">
                <i class="fas fa-gift me-2"></i>Điểm tích lũy & Ưu đãi
              </button>
            </li>
          </ul>

          <div class="tab-content" id="profileTabContent">
            <!-- Movie History Tab -->
            <div class="tab-pane fade show active" id="history" role="tabpanel">
              <div class="p-4">
                <div th:if="${watchedMovies.isEmpty()}" class="empty-state">
                  <i class="fas fa-ticket-alt"></i>
                  <h5>Chưa có lịch sử xem phim</h5>
                  <p>Bạn chưa xem bộ phim nào tại rạp của chúng tôi.</p>
                </div>

                <div th:if="${!watchedMovies.isEmpty()}" class="movie-history-grid">
                  <div class="movie-item" th:each="items, iterStat : ${watchedMovies}">
                    <button class="btn btn-outline-info mb-3"
                            th:attr="data-invoice-id=${items.invoiceId}"
                            onclick="showInvoiceDetail(this)">
                      <i class="fas fa-receipt me-1"></i>Chi tiết hóa đơn
                    </button>

                    <div class="movie-card-layout">
                      <div class="movie-poster">
                        <img th:src="${items.movie.image}" alt="Poster phim" th:alt="${items.movie.movieName}">
                      </div>

                      <div class="movie-content">
                        <h3 class="movie-title" th:text="${items.movie.movieName}">Dune: Hành Trình Cát - Phần 2</h3>

                        <div class="movie-meta">
                          <div class="movie-detail">
                            <i class="fas fa-clock"></i>
                            <span th:text="${items.movie.duration} + ' phút'">120 phút</span>
                          </div>
                          <div class="movie-detail">
                            <i class="fas fa-building"></i>
                            <span th:text="${items.movie.studio}">Studio</span>
                          </div>
                          <div class="movie-detail">
                            <i class="fas fa-map-marker-alt"></i>
                            <span th:text="${items.theater.theaterName}">Quận 1</span>
                          </div>
                        </div>

                        <div class="theater-badge" th:text="'Rạp ' + ${items.theater.theaterName}">
                          Rạp Quận 1
                        </div>

                        <div class="movie-datetime">
                          25/08/2025 | 19:30 - 22:15
                        </div>

                        <div class="movie-rating">
                          <div class="rating-display">
                            <span class="rating-stars">★★★★★</span>
                            <span class="rating-value" th:text="${#numbers.formatDecimal(items.movie.movieRate, 1, 1)} + '/5'">4.5/5</span>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="movie-feedback">
                      <form th:action="@{/feedback/submit}" method="post" class="feedback-form">
                        <input type="hidden" name="customerId" th:value="${customer.id}" />
                        <input type="hidden" name="theaterId" th:value="${items.theater.theaterID}" />

                        <textarea name="content" rows="2" class="form-control" placeholder="Góp ý về dịch vụ rạp..."></textarea>

                        <div class="input-group">
                          <label class="input-group-text">
                            <i class="fas fa-star text-warning"></i> Đánh giá
                          </label>
                          <select class="form-select" name="serviceRate">
                            <option value="5">Rất tốt</option>
                            <option value="4">Tốt</option>
                            <option value="3">Bình thường</option>
                            <option value="2">Tệ</option>
                            <option value="1">Rất tệ</option>
                          </select>
                        </div>

                        <button class="btn btn-outline-primary" type="submit">
                          <i class="fas fa-paper-plane me-1"></i>Gửi đánh giá
                        </button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Points & Rewards Tab -->
            <div class="tab-pane fade" id="points" role="tabpanel">
              <div class="p-4">
                <div class="mb-4">
                  <p class="mb-3">Bạn hiện có <strong class="points-display" th:text="${customer.point}">150</strong> điểm tích lũy.</p>
                  <p class="text-muted">Hãy tiếp tục tích điểm để nhận nhiều phần quà hấp dẫn!</p>
                </div>

                <hr class="my-4">

                <h5 class="mt-4 mb-3"><i class="fas fa-exchange-alt me-2"></i>Quy đổi điểm thưởng</h5>
                <div class="table-responsive">
                  <table class="table table-hover align-middle">
                    <thead>
                    <tr>
                      <th scope="col">Mốc điểm</th>
                      <th scope="col">Phần thưởng</th>
                      <th scope="col">Tình trạng</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                      <td><strong>100 điểm</strong></td>
                      <td>1 vé xem phim miễn phí</td>
                      <td>
                        <span class="badge bg-success" th:if="${customer.point >= 100}">Đủ điều kiện</span>
                        <span class="badge bg-secondary" th:unless="${customer.point >= 100}">Chưa đủ</span>
                      </td>
                    </tr>
                    <tr>
                      <td><strong>200 điểm</strong></td>
                      <td>1 combo bắp + nước</td>
                      <td>
                        <span class="badge bg-success" th:if="${customer.point >= 200}">Đủ điều kiện</span>
                        <span class="badge bg-secondary" th:unless="${customer.point >= 200}">Chưa đủ</span>
                      </td>
                    </tr>
                    <tr>
                      <td><strong>300 điểm</strong></td>
                      <td>Voucher giảm 50% cho 1 vé tiếp theo</td>
                      <td>
                        <span class="badge bg-success" th:if="${customer.point >= 300}">Đủ điều kiện</span>
                        <span class="badge bg-secondary" th:unless="${customer.point >= 300}">Chưa đủ</span>
                      </td>
                    </tr>
                    <tr>
                      <td><strong>500 điểm</strong></td>
                      <td>2 vé VIP + Combo đặc biệt</td>
                      <td>
                        <span class="badge bg-success" th:if="${customer.point >= 500}">Đủ điều kiện</span>
                        <span class="badge bg-secondary" th:unless="${customer.point >= 500}">Chưa đủ</span>
                      </td>
                    </tr>
                    </tbody>
                  </table>
                </div>

                <div class="mt-4 p-3 bg-light rounded">
                  <p class="mb-0 text-muted">
                    <i class="fas fa-info-circle me-2"></i>
                    Điểm thưởng có thể được quy đổi tại quầy vé hoặc trong mục "Ưu đãi" của ứng dụng.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column: Personal Information -->
      <div class="profile-card">
        <div class="card-header-custom">
          <i class="fas fa-user"></i>
          Thông tin cá nhân
        </div>
        <div class="card-body-custom">
          <div class="info-row">
            <div class="info-label">
              <i class="fas fa-signature"></i>
              Họ tên:
            </div>
            <div class="info-value" th:text="${customer.fullName}">Nguyễn Văn A</div>
          </div>
          <div class="info-row">
            <div class="info-label">
              <i class="fas fa-phone"></i>
              Số điện thoại:
            </div>
            <div class="info-value" th:text="${customer.phone}">0901234567</div>
          </div>
          <div class="info-row">
            <div class="info-label">
              <i class="fas fa-star"></i>
              Điểm tích lũy
            </div>
            <div class="info-value">
              <span class="points-display" th:text="${customer.point} + ' điểm'">150 điểm</span>
            </div>
          </div>
          <div class="mt-4">
            <button class="btn btn-edit" onclick="toggleEditForm()">
              <i class="fas fa-edit me-2"></i>Chỉnh sửa thông tin
            </button>

            <!-- Edit Form -->
            <div th:if="${errorMessage}" class="alert alert-danger mt-3" th:text="${errorMessage}"></div>
            <form th:action="@{/user/profile/update}" method="post" class="mt-4" id="editForm" style="display: none;">
              <input type="hidden" name="customerId" th:value="${customer.id}"/>
              <input type="hidden" name="accountId" th:value="${account.id}"/>

              <div class="mb-3">
                <label for="fullName" class="form-label">Họ tên</label>
                <input type="text" class="form-control" id="fullName" name="fullName"
                       th:value="${inputFullName != null ? inputFullName : customer.fullName}" required>
              </div>

              <div class="mb-3">
                <label for="phone" class="form-label">Số điện thoại</label>
                <input type="text" class="form-control" id="phone" name="phone"
                       th:value="${inputPhone != null ? inputPhone : customer.phone}">
              </div>

              <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" name="email"
                       th:value="${inputEmail != null ? inputEmail : account.email}" required>
              </div>

              <div class="mb-3">
                <label for="newPassword" class="form-label">Mật khẩu mới</label>
                <input type="password" class="form-control" id="newPassword" name="newPassword">
              </div>

              <div class="mb-3">
                <label for="confirmPassword" class="form-label">Xác nhận mật khẩu mới</label>
                <input type="password" class="form-control" id="confirmPassword" name="confirmPassword">
              </div>

              <div class="mb-3">
                <label for="otp" class="form-label">Mã OTP</label>
                <div class="d-flex gap-2">
                  <input type="text" class="form-control" id="otp" name="otp" placeholder="Nhập mã OTP" required>
                  <button type="button" class="btn btn-warning" onclick="sendOtp()">Gửi OTP</button>
                </div>
                <small id="otpStatus" class="text-muted"></small>
              </div>

              <div class="d-flex gap-2">
                <button type="submit" class="btn btn-success">
                  <i class="fas fa-save me-2"></i>Lưu thay đổi
                </button>
                <button type="button" class="btn btn-secondary" onclick="toggleEditForm()">
                  <i class="fas fa-times me-2"></i>Hủy
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Footer -->
<footer class="footer">
  <div class="container text-center text-md-left">
    <div class="row text-center text-md-left">
      <div class="col-md-3 col-lg-3 col-xl-3 mx-auto mt-3">
        <h5 class="text-uppercase mb-4 font-weight-bold text-warning">Cinema</h5>
        <p>Trải nghiệm điện ảnh tuyệt vời cùng chúng tôi!</p>
      </div>
      <div class="col-md-2 col-lg-2 col-xl-2 mx-auto mt-3">
        <h6 class="text-uppercase mb-4 font-weight-bold">Links</h6>
        <p><a href="#" class="text-light" style="text-decoration: none;">Trang chủ</a></p>
        <p><a href="#" class="text-light" style="text-decoration: none;">Phim</a></p>
        <p><a href="#" class="text-light" style="text-decoration: none;">Lịch chiếu</a></p>
        <p><a href="#" class="text-light" style="text-decoration: none;">Liên hệ</a></p>
      </div>
      <div class="col-md-3 col-lg-2 col-xl-2 mx-auto mt-3">
        <h6 class="text-uppercase mb-4 font-weight-bold">Hỗ trợ</h6>
        <p><a href="#" class="text-light" style="text-decoration: none;">FAQ</a></p>
        <p><a href="#" class="text-light" style="text-decoration: none;">Điều khoản</a></p>
        <p><a href="#" class="text-light" style="text-decoration: none;">Chính sách bảo mật</a></p>
      </div>
      <div class="col-md-4 col-lg-3 col-xl-3 mx-auto mt-3">
        <h6 class="text-uppercase mb-4 font-weight-bold">Liên hệ</h6>
        <p><i class="fas fa-home mr-3"></i> HÒA LẠC, TP HÀ NỘI</p>
        <p><i class="fas fa-envelope mr-3"></i> support@cinema.com</p>
        <p><i class="fas fa-phone mr-3"></i> +84 123 456 789</p>
      </div>
    </div>
    <hr class="mb-4">
    <div class="row align-items-center">
      <div class="col-md-7 col-lg-8">
        <p>© 2025 Cinema. All Rights Reserved.</p>
      </div>
      <div class="col-md-5 col-lg-4">
        <div class="text-center text-md-right">
          <ul class="list-unstyled list-inline">
            <li class="list-inline-item">
              <a href="#" class="btn-floating btn-sm text-light" style="font-size:23px;"><i class="fab fa-facebook"></i></a>
            </li>
            <li class="list-inline-item">
              <a href="#" class="btn-floating btn-sm text-light" style="font-size:23px;"><i class="fab fa-twitter"></i></a>
            </li>
            <li class="list-inline-item">
              <a href="#" class="btn-floating btn-sm text-light" style="font-size:23px;"><i class="fab fa-instagram"></i></a>
            </li>
            <li class="list-inline-item">
              <a href="#" class="btn-floating btn-sm text-light" style="font-size:23px;"><i class="fab fa-linkedin"></i></a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>

<!-- Invoice Detail Modal -->
<div class="modal fade" id="invoiceDetailModal" tabindex="-1" aria-labelledby="invoiceDetailLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="invoiceDetailLabel">Chi tiết hóa đơn</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <p><strong>Rạp:</strong> <span id="modalTheater"></span></p>
            <p><strong>Phòng chiếu:</strong> <span id="modalRoom"></span></p>
            <p><strong>Ngày đặt:</strong> <span id="modalDate"></span></p>
            <p><strong>Ghế:</strong> <span id="modalSeats"></span></p>
          </div>
          <div class="col-md-6">
            <p><strong>Đồ ăn:</strong> <span id="modalFoods"></span></p>
            <p><strong>Giảm giá:</strong> <span id="modalDiscount"></span></p>
            <p><strong>Tổng tiền:</strong> <span id="modalTotal"></span></p>
            <p><strong>Trạng thái:</strong> <span id="modalStatus"></span></p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  function sendOtp() {
    const email = document.getElementById("email").value;
    const otpStatus = document.getElementById("otpStatus");

    if (!email) {
      otpStatus.innerText = "Vui lòng nhập email trước.";
      otpStatus.className = "text-danger";
      return;
    }

    otpStatus.innerText = "Đang gửi OTP...";
    otpStatus.className = "text-info";

    fetch('/user/send-otp', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: `email=${encodeURIComponent(email)}`
    })
            .then(response => response.text())
            .then(data => {
              otpStatus.innerText = data;
              otpStatus.className = data.includes("thành công") ? "text-success" : "text-danger";
            })
            .catch(error => {
              otpStatus.innerText = "Gửi OTP thất bại.";
              otpStatus.className = "text-danger";
            });
  }

  // Initialize Bootstrap tabs
  const triggerTabList = document.querySelectorAll('#profileTabs button');
  triggerTabList.forEach(triggerEl => {
    const tabTrigger = new bootstrap.Tab(triggerEl);
    triggerEl.addEventListener('click', event => {
      event.preventDefault();
      tabTrigger.show();
    });
  });

  // Add smooth scrolling and fade-in animations
  document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.profile-card');
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.style.opacity = '1';
          entry.target.style.transform = 'translateY(0)';
        }
      });
    }, { threshold: 0.1 });

    cards.forEach(card => {
      card.style.opacity = '0';
      card.style.transform = 'translateY(20px)';
      card.style.transition = 'all 0.6s ease';
      observer.observe(card);
    });
  });

  function toggleEditForm() {
    const form = document.getElementById("editForm");
    form.style.display = form.style.display === "none" ? "block" : "none";
  }

  // Form validation
  document.querySelector('form').addEventListener('submit', function(e) {
    const pass = document.getElementById('newPassword').value;
    const confirm = document.getElementById('confirmPassword').value;

    if (pass && pass !== confirm) {
      alert("Mật khẩu xác nhận không khớp!");
      e.preventDefault();
      return;
    }

    // Show loading overlay
    document.getElementById('loadingOverlay').style.display = 'flex';
  });

  function showInvoiceDetail(button) {
    const invoiceId = button.getAttribute("data-invoice-id");

    // Show loading
    document.getElementById('loadingOverlay').style.display = 'flex';

    fetch(`/invoice/${invoiceId}/detail`)
            .then(res => {
              if (!res.ok) {
                throw new Error(`Server trả về lỗi: ${res.status}`);
              }
              return res.json();
            })
            .then(data => {
              document.getElementById("modalTheater").textContent = data.theaterName;
              document.getElementById("modalRoom").textContent = data.roomName;
              document.getElementById("modalDate").textContent = new Date(data.bookingDate).toLocaleString('vi-VN');
              document.getElementById("modalSeats").textContent = data.seats.join(', ');
              document.getElementById("modalFoods").textContent = data.foodItems.length > 0 ? data.foodItems.join(', ') : "Không có";
              document.getElementById("modalDiscount").textContent = new Intl.NumberFormat('vi-VN').format(data.discount) + " đ";
              document.getElementById("modalTotal").textContent = new Intl.NumberFormat('vi-VN').format(data.totalPrice) + " đ";
              document.getElementById("modalStatus").textContent = data.status;

              const modal = new bootstrap.Modal(document.getElementById("invoiceDetailModal"));
              modal.show();
            })
            .catch(err => {
              alert("Lỗi khi tải chi tiết hóa đơn.");
              console.error("Chi tiết lỗi:", err);
            })
            .finally(() => {
              // Hide loading
              document.getElementById('loadingOverlay').style.display = 'none';
            });
  }

  // Smooth scroll for navigation
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
      e.preventDefault();
      const target = document.querySelector(this.getAttribute('href'));
      if (target) {
        target.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
      }
    });
  });
</script>

</body>
</html>